<%# On connecte le contrôleur Stimulus au formulaire %>
<%= form_with(model: reservation, local: true, data: { controller: "reservation-form" }) do |form| %>
  <% if reservation.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(reservation.errors.count, "erreur") %> a empêché cette réservation d'être sauvegardée :</h5>
      <ul>
        <% reservation.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Champ caché pour gérer la redirection après une mise à jour depuis la page admin %>
  <%= hidden_field_tag :redirect_to, params[:redirect_to] if params[:redirect_to].present? %>

  <div class="mb-3">
    <%= form.label :avion_id, "Avion" %>
    <%# Ce champ va déclencher l'action `updateSignalements` du contrôleur Stimulus %>
    <%= form.collection_select :avion_id, @avions, :id, :immatriculation, {}, { 
      class: "form-select", 
      "data-reservation-form-target": "avionSelect",
      "data-action": "change->reservation-form#updateSignalements"
    } %>
  </div>

  <div class="row">
    <div class="col-md-2 mb-3">
      <%= form.label :start_date, "Date de début" %>
      <%# L'action `fetchInstructors` est ajoutée pour mettre à jour la liste des instructeurs via AJAX %>
      <%= form.date_field :start_date, class: "form-control", data: { reservation_form_target: "startDate", action: "change->reservation-form#updateEndDate change->reservation-form#fetchInstructors" } %>
    </div>
    <div class="col-md-2 mb-3">
      <%= form.label :start_hour, "Heure" %>
      <%= form.select :start_hour, (7..17).map { |h| [h.to_s.rjust(2, '0'), h] }, {}, { class: "form-select", data: { reservation_form_target: "startTime", action: "change->reservation-form#adjustEndTime change->reservation-form#fetchInstructors" } } %>
    </div>
    <div class="col-md-2 mb-3">
      <%= form.label :start_minute, "Min" %>
      <%= form.select :start_minute, (0..45).step(15).map { |m| [m.to_s.rjust(2, '0'), m] }, {}, { class: "form-select", data: { reservation_form_target: "startMinute", action: "change->reservation-form#adjustEndTime change->reservation-form#fetchInstructors" } } %>
    </div>
    <div class="col-md-2 mb-3">
      <%= form.label :end_date, "Date de fin" %>
      <%= form.date_field :end_date, class: "form-control", data: { reservation_form_target: "endDate" } %>
    </div>
    <div class="col-md-2 mb-3">
      <%= form.label :end_hour, "Heure" %>
      <%= form.select :end_hour, (7..18).map { |h| [h.to_s.rjust(2, '0'), h] }, {}, { class: "form-select", data: { reservation_form_target: "endTime" } } %>
    </div>
    <div class="col-md-2 mb-3">
      <%= form.label :end_minute, "Min" %>
      <%= form.select :end_minute, (0..45).step(15).map { |m| [m.to_s.rjust(2, '0'), m] }, {}, { class: "form-select", data: { reservation_form_target: "endMinute" } } %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :type_vol, "Type de vol" %>
    <%= form.select :type_vol, ["Local", "Navigation", "Mania"], {}, { class: "form-select" } %>
  </div>

  <div class="form-check form-switch mb-3">
    <%# On ajoute un `data-action` pour déclencher notre JavaScript au changement %>
    <%= form.check_box :instruction, { class: "form-check-input", data: { action: "reservation-form#toggleInstructor" } } %>
    <%= form.label :instruction, "Vol en instruction", class: "form-check-label" %>
  </div>

  <%# On enveloppe la liste des instructeurs dans une div avec un `data-target` %>
  <div class="mb-3" data-reservation-form-target="instructorSelect">
    <%= form.label :fi, "Instructeur" %>
    <%# La cible `instructorOptions` est ajoutée pour permettre au JavaScript de remplacer uniquement les options %>
    <%= form.collection_select :fi, @instructeurs, :name, :name, {}, { class: "form-select", "data-reservation-form-target": "instructorOptions" } %>
  </div>

  <div class="form-actions mt-4 mb-5 border-top pt-3">
    <%= form.submit "Enregistrer la réservation", class: "btn btn-success", data: { reservation_form_target: "submitButton" } %>
    <%= link_to 'Annuler', root_path, class: 'btn btn-outline-primary ms-2' %>
  </div>

  <%# Ce Turbo Frame sera mis à jour dynamiquement avec les signalements de l'avion sélectionné %>
  <%# Pour une réservation existante, on charge les signalements tout de suite %>
  <%= turbo_frame_tag "signalements_avion", src: (signalements_list_avion_path(reservation.avion) if reservation.persisted?), data: { reservation_form_target: "signalementsFrame" } %>
<% end %>
