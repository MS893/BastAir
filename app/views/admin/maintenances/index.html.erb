<div class="container my-5">
  <h1 class="text-center mb-5">Gestion de la Maintenance des Avions</h1>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="flex-grow-1 me-4">
      <%= form_with url: admin_maintenances_path, method: :get, class: "d-flex align-items-center" do |f| %>
        <%= f.label :avion_id, "Sélectionner un avion :", class: "fw-bold me-2" %>
        <%= f.select :avion_id, 
            options_from_collection_for_select(@avions, :id, :immatriculation, @selected_avion&.id), 
            {}, 
            class: "form-select w-auto", 
            onchange: "this.form.requestSubmit()" %>
        <% if @selected_avion %>
          <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#maintenanceSettingsModal" title="Paramètres de maintenance">
            <i class="bi bi-gear-fill"></i>
          </button>
        <% end %>
      <% end %>
    </div>
    <% if @selected_avion %>
      <%= link_to admin_maintenance_path(@selected_avion, format: :pdf), class: "btn btn-outline-primary me-2", target: "_blank" do %>
        <i class="bi bi-file-earmark-pdf me-2"></i>Télécharger le dossier Maintenance
      <% end %>
    <% end %>
    <% grounded_avions = @avions.select(&:grounded?) %>
    <% if grounded_avions.any? %>
      <%= button_to notify_grounded_admin_maintenances_path, method: :post, class: "btn btn-outline-danger", data: { turbo_confirm: "Êtes-vous sûr ? Cela enverra un email d'annulation aux pilotes concernés par l'immobilisation (1 jour pour une visite 100h, 1 semaine pour une visite 2000h/potentiel)." } do %>
        <i class="bi bi-envelope-exclamation-fill me-2"></i>Notifier les annulations <span class="badge bg-danger ms-2" data-bs-toggle="tooltip" title="<%= grounded_avions.map(&:immatriculation).join(', ') %>"><%= grounded_avions.count %></span>
      <% end %>
    <% end %>
  </div>

  <%# Graphiques de suivi %>
  <div class="row mb-5">
    <div class="col-lg-6">
      <div class="card shadow h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-3">Consommation de potentiel (Heures de vol)</h5>
          <%= line_chart @flight_hours_chart_data, colors: ["#198754"], ytitle: "Heures volées", height: "170px" %>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-3">Projection d'épuisement du potentiel (Basé sur l'activité des 12 derniers mois)</h5>
          <p class="text-muted text-center small">Estimation linéaire. La projection est limitée à 2 ans.</p>
          <%= line_chart @forecast_chart_data, height: "170px", ytitle: "Potentiel restant (h)", min: 0 %>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0"><i class="bi bi-airplane me-2"></i>Maintenance avion(s)</h3>
      </div>
      <% if @selected_avion %>
        <% 
          # Logique pour les alertes d'indisponibilité ou d'avertissement
          avion = @selected_avion
          is_grounded = avion.grounded?
          reasons = []

          if is_grounded
            reasons << "Potentiel moteur épuisé" if avion.potentiel_moteur <= 0
            reasons << "Visite 100h dépassée" if avion.next_100h.present? && avion.next_100h <= 0
            reasons << "Visite annuelle expirée" if avion.annuelle.present? && avion.annuelle < Date.today
            reasons << "CEN expiré" if avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < Date.today
          end

          is_warning = !is_grounded && (
                        avion.potentiel_moteur < 50 || 
                        (avion.next_100h.present? && avion.next_100h < 10) || 
                        (avion.annuelle.present? && avion.annuelle < 30.days.from_now.to_date) || 
                        (avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < 30.days.from_now.to_date)
                      )
          
          if is_warning
            reasons << "Potentiel moteur faible (< 50h)" if avion.potentiel_moteur < 50
            reasons << "Visite 100h proche (< 10h)" if avion.next_100h.present? && avion.next_100h < 10
            reasons << "Visite annuelle proche (< 30j)" if avion.annuelle.present? && avion.annuelle < 30.days.from_now.to_date
            reasons << "CEN proche (< 30j)" if avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < 30.days.from_now.to_date
          end
        %>

        <div class="card shadow <%= is_grounded ? 'border-danger' : (is_warning ? 'border-warning' : '') %>">
          <% if reasons.any? %>
            <div class="card-header <%= is_grounded ? 'bg-danger text-white' : 'bg-warning text-dark' %>">
              <i class="bi <%= is_grounded ? 'bi-exclamation-octagon-fill' : 'bi-exclamation-triangle-fill' %> me-2"></i>
              <strong><%= is_grounded ? "AVION INDISPONIBLE" : "ATTENTION" %> :</strong> <%= reasons.join(', ') %>
            </div>
          <% end %>

          <% 
            # Logique pour les alertes visuelles sur les onglets
            # Moteur : Potentiel, 100h, 50h, CEN
            alert_moteur = @selected_avion.potentiel_moteur <= 0 || (@selected_avion.next_100h.present? && @selected_avion.next_100h <= 0) || (@check_50h && @selected_avion.next_50h.present? && @selected_avion.next_50h <= 0) || (@check_1000h && @selected_avion.next_1000h.present? && @selected_avion.next_1000h <= 0) || (@selected_avion.cert_examen_navigabilite.present? && @selected_avion.cert_examen_navigabilite < Date.today)
            warning_moteur = @selected_avion.potentiel_moteur < 50 || (@selected_avion.next_100h.present? && @selected_avion.next_100h < 10) || (@check_50h && @selected_avion.next_50h.present? && @selected_avion.next_50h < 10) || (@check_1000h && @selected_avion.next_1000h.present? && @selected_avion.next_1000h < 50) || (@selected_avion.cert_examen_navigabilite.present? && @selected_avion.cert_examen_navigabilite < 30.days.from_now.to_date)
            
            # Cellule : Annuelle, GV
            alert_cellule = (@check_annuelle && @selected_avion.annuelle.present? && @selected_avion.annuelle < Date.today) || (@selected_avion.gv.present? && @selected_avion.gv < Date.today)
            warning_cellule = (@check_annuelle && @selected_avion.annuelle.present? && @selected_avion.annuelle < 30.days.from_now.to_date) || (@selected_avion.gv.present? && @selected_avion.gv < 30.days.from_now.to_date)

            # Hélice
            alert_helice = @selected_avion.tbo_helice.present? && @selected_avion.tbo_helice < Date.today
            warning_helice = @selected_avion.tbo_helice.present? && @selected_avion.tbo_helice < 30.days.from_now.to_date

            # Parachute
            alert_parachute = @selected_avion.tbo_parachute.present? && @selected_avion.tbo_parachute < Date.today
            warning_parachute = @selected_avion.tbo_parachute.present? && @selected_avion.tbo_parachute < 30.days.from_now.to_date
          %>
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="maintenanceTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="avion-tab" data-bs-toggle="tab" data-bs-target="#avion" type="button" role="tab" aria-controls="avion" aria-selected="true">
                  Avion
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="moteur-tab" data-bs-toggle="tab" data-bs-target="#moteur" type="button" role="tab" aria-controls="moteur" aria-selected="false">
                  Moteur <%= raw('<span class="badge bg-danger rounded-pill ms-2">!</span>') if alert_moteur %> <%= raw('<span class="badge bg-warning text-dark rounded-pill ms-2">!</span>') if !alert_moteur && warning_moteur %>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="cellule-tab" data-bs-toggle="tab" data-bs-target="#cellule" type="button" role="tab" aria-controls="cellule" aria-selected="false">
                  Cellule <%= raw('<span class="badge bg-danger rounded-pill ms-2">!</span>') if alert_cellule %> <%= raw('<span class="badge bg-warning text-dark rounded-pill ms-2">!</span>') if !alert_cellule && warning_cellule %>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="helice-tab" data-bs-toggle="tab" data-bs-target="#helice" type="button" role="tab" aria-controls="helice" aria-selected="false">
                  Hélice <%= raw('<span class="badge bg-danger rounded-pill ms-2">!</span>') if alert_helice %> <%= raw('<span class="badge bg-warning text-dark rounded-pill ms-2">!</span>') if !alert_helice && warning_helice %>
                </button>
              </li>
              <% if @check_parachute %>
                <li class="nav-item" role="presentation">
                  <button class="nav-link d-flex align-items-center" id="parachute-tab" data-bs-toggle="tab" data-bs-target="#parachute" type="button" role="tab" aria-controls="parachute" aria-selected="false">
                    Parachute <%= raw('<span class="badge bg-danger rounded-pill ms-2">!</span>') if alert_parachute %> <%= raw('<span class="badge bg-warning text-dark rounded-pill ms-2">!</span>') if !alert_parachute && warning_parachute %>
                  </button>
                </li>
              <% end %>
            </ul>
          </div>
          
          <div class="card-body">
            <%= form_with model: @selected_avion, url: admin_maintenance_path(@selected_avion), method: :patch do |f| %>
              <div class="tab-content" id="maintenanceTabsContent">
                
                <%# TAB AVION %>
                <div class="tab-pane fade show active" id="avion" role="tabpanel" aria-labelledby="avion-tab">
                  <div class="row g-3">

                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Immatriculation</h6>
                          <%= f.text_field :immatriculation, class: "form-control-plaintext mb-2", readonly: true %>
                          <h6 class="card-title fw-bold">Moteur</h6>
                          <%= f.text_field :moteur, class: "form-control" %>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Modèle</h6>
                          <%= f.text_field :modele, class: "form-control mb-3" %>
                          <h6 class="card-title fw-bold">Marque</h6>
                          <%= f.text_field :marque, class: "form-control" %>
                        </div>
                      </div>
                    </div>

                    <%# CEN %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Certificat d'Examen de Navigabilité (CEN)</h6>
                          <div class="input-group mb-2">
                            <%= f.date_field :cert_examen_navigabilite, class: "form-control fw-bold text-center", min: Date.today %>
                          </div>
                          <div class="mb-2">
                            <%= f.file_field :cen_document, class: "form-control form-control-sm", accept: "application/pdf" %>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <% if @selected_avion.cen_document.attached? %>
                                <%= link_to rails_blob_path(@selected_avion.cen_document, 
                                    disposition: 'preview'), target: "_blank", 
                                    class: "badge bg-secondary text-decoration-none" do %>
                                <% end %>
                              <% end %>
                              <small class="text-muted">Vous pouvez uploader le scan pdf du nouveau CEN</small>
                            </div>
                            <%= link_to reset_cen_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Valider le CEN (+1 an) ?" }, 
                                class: "btn btn-sm btn-info text-white", title: "Valider CEN" do %>
                              <i class="bi bi-pencil-square-earmark-check"></i> Valider
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <%# TAB MOTEUR %>
                <div class="tab-pane fade" id="moteur" role="tabpanel" aria-labelledby="moteur-tab">
                  <div class="row g-3">

                    <%# Visite 50h %>
                    <% if @check_50h %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Visite 50h</h6>
                          <div class="input-group mb-2">
                            <%= f.number_field :next_50h, step: 0.01, class: "form-control fw-bold text-end" %>
                            <span class="input-group-text">h</span>
                          </div>
                          <div class="progress mb-2" style="height: 20px;">
                            <% percent_50h = (@selected_avion.next_50h.to_f / 50.0 * 100).clamp(0, 100) %>
                            <div class="progress-bar <%= percent_50h < 10 ? 'bg-danger' : 'bg-success' %>" role="progressbar" style="width: <%= percent_50h %>%">
                              <%= percent_50h.round %>%
                            </div>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Sur 50h</small>
                            <%= link_to reset_50h_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Reset Visite 50h ?" }, 
                                class: "btn btn-sm btn-warning", title: "Reset 50h" do %>
                              <i class="bi bi-arrow-counterclockwise"></i> Reset
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% end %>

                    <%# Visite 100h %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Visite 100h</h6>
                          <div class="input-group mb-2">
                            <%= f.number_field :next_100h, step: 0.01, class: "form-control fw-bold text-end" %>
                            <span class="input-group-text">h</span>
                          </div>
                          <div class="progress mb-2" style="height: 20px;">
                            <% percent_100h = (@selected_avion.next_100h.to_f / 100.0 * 100).clamp(0, 100) %>
                            <div class="progress-bar <%= percent_100h < 10 ? 'bg-danger' : 'bg-success' %>" role="progressbar" style="width: <%= percent_100h %>%">
                              <%= percent_100h.round %>%
                            </div>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Sur 100h</small>
                            <%= link_to reset_100h_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Reset Visite 100h ?" }, 
                                class: "btn btn-sm btn-warning", title: "Reset 100h" do %>
                              <i class="bi bi-arrow-counterclockwise"></i> Reset
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>

                    <%# Visite 1000h %>
                    <% if @check_1000h %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Visite 1000h</h6>
                          <div class="input-group mb-2">
                            <%= f.number_field :next_1000h, step: 0.01, class: "form-control fw-bold text-end" %>
                            <span class="input-group-text">h</span>
                          </div>
                          <div class="progress mb-2" style="height: 20px;">
                            <% percent_1000h = (@selected_avion.next_1000h.to_f / 1000.0 * 100).clamp(0, 100) %>
                            <div class="progress-bar <%= percent_1000h < 10 ? 'bg-danger' : 'bg-success' %>" role="progressbar" style="width: <%= percent_1000h %>%">
                              <%= percent_1000h.round %>%
                            </div>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Sur 1000h</small>
                            <%= link_to reset_1000h_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Reset Visite 1000h ?" }, 
                                class: "btn btn-sm btn-warning", title: "Reset 1000h" do %>
                              <i class="bi bi-arrow-counterclockwise"></i> Reset
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% end %>

                    <%# Potentiel Moteur %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Potentiel Moteur</h6>
                          <div class="input-group mb-2">
                            <%= f.number_field :potentiel_moteur, step: 0.01, class: "form-control fw-bold text-end" %>
                            <span class="input-group-text">h</span>
                          </div>
                          <div class="progress mb-2" style="height: 20px;">
                            <% percent_moteur = (@selected_avion.potentiel_moteur / 2000.0 * 100).clamp(0, 100) %>
                            <div class="progress-bar <%= percent_moteur < 10 ? 'bg-danger' : 'bg-success' %>" role="progressbar" style="width: <%= percent_moteur %>%">
                              <%= percent_moteur.round %>%
                            </div>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Sur 2000h</small>
                            <%= link_to reset_moteur_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Êtes-vous sûr de vouloir réinitialiser le potentiel moteur à 2000h ?" }, 
                                class: "btn btn-sm btn-warning", title: "Reset Moteur" do %>
                              <i class="bi bi-arrow-counterclockwise"></i> Reset
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <%# TAB CELLULE %>
                <div class="tab-pane fade" id="cellule" role="tabpanel" aria-labelledby="cellule-tab">
                  <div class="row g-3">

                    <%# Visite Annuelle %>
                    <% if @check_annuelle %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Visite Annuelle</h6>
                          <div class="input-group mb-2">
                            <%= f.date_field :annuelle, class: "form-control fw-bold text-center", min: Date.today %>
                          </div>
                          <div class="d-flex justify-content-between align-items-center">
                            <% if @selected_avion.annuelle %>
                              <% days = (@selected_avion.annuelle - Date.today).to_i %>
                              <small class="<%= days < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                                <%= days >= 0 ? "Dans #{days} jours" : "Retard #{days.abs} jours" %>
                              </small>
                            <% else %>
                              <small class="text-muted">Non définie</small>
                            <% end %>
                            <%= link_to reset_annuelle_admin_maintenance_path(@selected_avion), 
                                data: { turbo_method: :patch, turbo_confirm: "Valider Visite Annuelle (+1 an) ?" }, 
                                class: "btn btn-sm btn-info text-white", title: "Valider Annuelle" do %>
                              <i class="bi bi-calendar-check"></i> Valider
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% end %>

                    <%# GV %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Grande Visite (GV)</h6>
                          <div class="input-group mb-2">
                            <%= f.date_field :gv, class: "form-control fw-bold text-center", min: Date.today %>
                          </div>
                          <% if @selected_avion.gv %>
                            <% days_gv = (@selected_avion.gv - Date.today).to_i %>
                            <small class="<%= days_gv < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                              <%= days_gv >= 0 ? "Dans #{days_gv} jours" : "Retard #{days_gv.abs} jours" %>
                            </small>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <%# Potentiel Cellule %>
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">Potentiel Cellule</h6>
                          <div class="input-group mb-2">
                            <%= f.number_field :potentiel_cellule, step: 0.01, class: "form-control fw-bold text-end" %>
                            <span class="input-group-text">h</span>
                          </div>
                          <small class="text-muted">Heures restantes</small>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <%# TAB HELICE %>
                <div class="tab-pane fade" id="helice" role="tabpanel" aria-labelledby="helice-tab">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="card h-100 border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">TBO Hélice</h6>
                          <div class="input-group mb-2">
                            <%= f.date_field :tbo_helice, class: "form-control fw-bold text-center", min: Date.today %>
                          </div>
                          <% if @selected_avion.tbo_helice %>
                            <% days_helice = (@selected_avion.tbo_helice - Date.today).to_i %>
                            <small class="<%= days_helice < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                              <%= days_helice >= 0 ? "Dans #{days_helice} jours" : "Retard #{days_helice.abs} jours" %>
                            </small>
                          <% end %>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <%# TAB PARACHUTE %>
                <% if @check_parachute %>
                  <div class="tab-pane fade" id="parachute" role="tabpanel" aria-labelledby="parachute-tab">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="card h-100 border-0 bg-info bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title fw-bold">TBO Parachute</h6>
                            <div class="input-group mb-2">
                            <%= f.date_field :tbo_parachute, class: "form-control fw-bold text-center", min: Date.today %>
                            </div>
                            <% if @selected_avion.tbo_parachute %>
                              <% days_para = (@selected_avion.tbo_parachute - Date.today).to_i %>
                              <small class="<%= days_para < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                                <%= days_para >= 0 ? "Dans #{days_para} jours" : "Retard #{days_para.abs} jours" %>
                              </small>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>

              </div>

              <div class="mt-4 text-end">
                <%= f.button type: "submit", class: "btn btn-primary" do %>
                  <i class="bi bi-save me-2"></i>Enregistrer les modifications
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info text-center">
          Veuillez sélectionner un avion pour afficher ses informations de maintenance.
        </div>
      <% end %>
    </div>
  </div>

  <%# Section Historique %>
  <div class="row mt-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique des opérations</h3>
      </div>
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped table-sm align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Utilisateur</th>
                  <th>Avion</th>
                  <th>Action</th>
                  <th>Détails</th>
                </tr>
              </thead>
              <tbody>
                <% @logs.each do |log| %>
                  <tr>
                    <td><%= log.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                    <td><%= log.user.respond_to?(:full_name) ? log.user.full_name : log.user.email %></td>
                    <td>
                      <% if log.record_type == 'Avion' %>
                        <% avion = Avion.find_by(id: log.record_id) %>
                        <span class="badge bg-secondary"><%= avion ? avion.immatriculation : "Avion supprimé" %></span>
                      <% else %>
                        <span class="badge bg-secondary"><%= log.record_type %></span>
                      <% end %>
                    </td>
                    <td>
                      <% case log.action %>
                      <% when 'reset_100h' %>
                        <span class="badge bg-warning text-dark">Reset 100h</span>
                      <% when 'reset_1000h' %>
                        <span class="badge bg-warning text-dark">Reset 1000h</span>
                      <% when 'reset_moteur' %>
                        <span class="badge bg-danger">Reset Moteur</span>
                      <% when 'update_maintenance' %>
                        <span class="badge bg-info text-dark">Mise à jour manuelle</span>
                      <% when 'reset_annuelle' %>
                        <span class="badge bg-primary">Visite Annuelle</span>
                      <% when 'reset_cen' %>
                        <span class="badge bg-secondary">CEN</span>
                      <% when 'notify_grounded' %>
                        <span class="badge bg-danger">Notifications Pilotes</span>
                      <% else %>
                        <%= log.action %>
                      <% end %>
                    </td>
                    <td class="text-muted small"><%= log.details %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <%# Pagination simple %>
          <% if @total_pages > 1 %>
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center mb-0">
                <li class="page-item <%= 'disabled' if @page <= 1 %>">
                  <%= link_to "Précédent", admin_maintenances_path(page: @page - 1, avion_id: params[:avion_id]), class: "page-link" %>
                </li>
                <li class="page-item disabled">
                  <span class="page-link">Page <%= @page %> / <%= @total_pages %></span>
                </li>
                <li class="page-item <%= 'disabled' if @page >= @total_pages %>">
                  <%= link_to "Suivant", admin_maintenances_path(page: @page + 1, avion_id: params[:avion_id]), class: "page-link" %>
                </li>
              </ul>
            </nav>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>

<%# Modale de paramètres de maintenance %>
<% if @selected_avion %>
  <div class="modal fade" id="maintenanceSettingsModal" tabindex="-1" aria-labelledby="maintenanceSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="maintenanceSettingsModalLabel">Paramètres de maintenance du <%= @selected_avion.immatriculation %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= form_with url: update_settings_admin_maintenance_path(@selected_avion), method: :post do |f| %>
          <div class="modal-body">
            <div class="form-check form-switch">
              <%= check_box_tag :check_50h, "1", @check_50h, class: "form-check-input", role: "switch" %>
              <%= label_tag :check_50h, "Suivi visite 50h", class: "form-check-label" %>
            </div>
            <div class="form-check form-switch mb-3">
              <%= check_box_tag :check_1000h, "1", @check_1000h, class: "form-check-input", role: "switch" %>
              <%= label_tag :check_1000h, "Suivi visite 1000h", class: "form-check-label" %>
            </div>
            <div class="form-check form-switch mb-3">
              <%= check_box_tag :check_annuelle, "1", @check_annuelle, class: "form-check-input", role: "switch" %>
              <%= label_tag :check_annuelle, "Suivi visite Annuelle", class: "form-check-label" %>
            </div>
            <div class="form-check form-switch mb-3">
              <%= check_box_tag :check_parachute, "1", @check_parachute, class: "form-check-input", role: "switch" %>
              <%= label_tag :check_parachute, "Suivi Parachute", class: "form-check-label" %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <%= f.submit "Enregistrer", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
