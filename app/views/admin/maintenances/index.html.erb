<div class="container my-5">
  <h1 class="text-center mb-4">Gestion de la Maintenance des Avions</h1>

  <div class="d-flex justify-content-end mb-4">
    <%= button_to notify_grounded_admin_maintenances_path, method: :post, class: "btn btn-outline-danger", data: { turbo_confirm: "Êtes-vous sûr ? Cela enverra un email d'annulation à tous les pilotes ayant une réservation future sur un avion marqué comme indisponible (rouge)." } do %>
      <i class="bi bi-envelope-exclamation-fill me-2"></i>Notifier les annulations (Avions indisponibles)
    <% end %>
  </div>

  <%# Graphiques de suivi %>
  <div class="row mb-5">
    <div class="col-lg-6">
      <div class="card shadow h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-3">Consommation de potentiel (Heures de vol)</h5>
          <%= line_chart @flight_hours_chart_data, colors: ["#198754"], ytitle: "Heures volées", height: "200px" %>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-3">Projection d'épuisement du potentiel (Basé sur l'activité des 12 derniers mois)</h5>
          <p class="text-muted text-center small">Estimation linéaire. La projection est limitée à 2 ans.</p>
          <%= line_chart @forecast_chart_data, height: "200px", ytitle: "Potentiel restant (h)", min: 0 %>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-12">
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-striped text-white">
                <tr>
                  <th>Avion</th>
                  <th class="text-center" style="width: 20%;">Potentiel Moteur</th>
                  <th class="text-center" style="width: 20%;">Visite 100h</th>
                  <th class="text-center" style="width: 15%;">Visite Annuelle</th>
                  <th class="text-center" style="width: 15%;">Certificat d'Examen de Navigabilité</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @avions.each do |avion| %>
                  <% 
                    is_grounded = avion.grounded?
                    reasons = []

                    if is_grounded
                      reasons << "Potentiel moteur épuisé" if avion.potentiel_moteur <= 0
                      reasons << "Visite 100h dépassée" if avion.next_100h.present? && avion.next_100h <= 0
                      reasons << "Visite annuelle expirée" if avion.annuelle.present? && avion.annuelle < Date.today
                      reasons << "CEN expiré" if avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < Date.today
                    end

                    is_warning = !is_grounded && (
                                  avion.potentiel_moteur < 50 || 
                                  (avion.next_100h.present? && avion.next_100h < 10) || 
                                  (avion.annuelle.present? && avion.annuelle < 30.days.from_now.to_date) || 
                                  (avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < 30.days.from_now.to_date)
                                )
                    
                    if is_warning
                      reasons << "Potentiel moteur faible (< 50h)" if avion.potentiel_moteur < 50
                      reasons << "Visite 100h proche (< 10h)" if avion.next_100h.present? && avion.next_100h < 10
                      reasons << "Visite annuelle proche (< 30j)" if avion.annuelle.present? && avion.annuelle < 30.days.from_now.to_date
                      reasons << "CEN proche (< 30j)" if avion.cert_examen_navigabilite.present? && avion.cert_examen_navigabilite < 30.days.from_now.to_date
                    end
                  %>
                  <tr class="<%= is_grounded ? 'table-danger' : (is_warning ? 'table-warning' : '') %>" 
                      data-bs-toggle="tooltip" data-bs-placement="top" title="<%= reasons.join(', ') %>">
                    <td class="fw-bold fs-6 text-nowrap"><%= avion.immatriculation %></td>
                    
                    <%# Formulaire pour l'édition manuelle %>
                    <%= form_with model: avion, url: admin_maintenance_path(avion), method: :patch, class: "d-contents" do |f| %>
                      
                      <td style="height: 1px;">
                        <div class="d-flex flex-column h-100">
                          <div>
                            <div class="input-group input-group mb-1">
                              <%= f.number_field :potentiel_moteur, step: 0.01, class: "form-control fw-bold text-end" %>
                              <span class="input-group-text">h</span>
                            </div>
                            <div class="progress" style="height: 24px;">
                              <% percent_moteur = (avion.potentiel_moteur / 2000.0 * 100).clamp(0, 100) %>
                              <div class="progress-bar <%= percent_moteur < 10 ? 'bg-danger' : 'bg-success' %> fw-bold" role="progressbar" style="width: <%= percent_moteur %>%">
                                <%= percent_moteur.round %>%
                              </div>
                            </div>
                            <div class="text-muted text-end mt-1">Sur 2000h</div>
                          </div>
                        <div class="mt-auto pt-2">
                          <%= link_to reset_moteur_admin_maintenance_path(avion), 
                              data: { turbo_method: :patch, turbo_confirm: "Êtes-vous sûr de vouloir réinitialiser le potentiel moteur à 2000h ?" }, 
                              class: "btn btn-sm btn-warning w-100", title: "Reset Moteur à 2000h" do %>
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                          <% end %>
                        </div>
                        </div>
                      </td>

                      <td style="height: 1px;">
                        <div class="d-flex flex-column h-100">
                          <div>
                            <div class="input-group input-group mb-1">
                              <%= f.number_field :next_100h, step: 0.01, class: "form-control fw-bold text-end" %>
                              <span class="input-group-text">h</span>
                            </div>
                            <div class="progress" style="height: 24px;">
                              <% percent_100h = (avion.next_100h.to_f / 100.0 * 100).clamp(0, 100) %>
                              <div class="progress-bar <%= percent_100h < 10 ? 'bg-danger' : 'bg-success' %> fw-bold" role="progressbar" style="width: <%= percent_100h %>%">
                                <%= percent_100h.round %>%
                              </div>
                            </div>
                            <div class="text-muted text-end mt-1">Sur 100h</div>
                          </div>
                        <div class="mt-auto pt-2">
                          <%= link_to reset_100h_admin_maintenance_path(avion), 
                              data: { turbo_method: :patch, turbo_confirm: "Êtes-vous sûr de vouloir réinitialiser la visite 100h ?" }, 
                              class: "btn btn-sm btn-warning w-100", title: "Reset Visite à 100h" do %>
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                          <% end %>
                        </div>
                        </div>
                      </td>

                      <td style="height: 1px;">
                        <div class="d-flex flex-column h-100">
                          <div>
                            <div class="input-group input-group mb-1">
                              <%= f.date_field :annuelle, class: "form-control fw-bold text-center" %>
                            </div>
                            <% if avion.annuelle %>
                              <% days_remaining = (avion.annuelle - Date.today).to_i %>
                              <div class="text-end mt-1">
                                <span class="<%= days_remaining < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                                  <%= days_remaining >= 0 ? "Dans #{days_remaining} jours" : "En retard de #{days_remaining.abs} jours" %>
                                </span>
                              </div>
                            <% end %>
                          </div>
                        <div class="mt-auto pt-2">
                          <%= link_to reset_annuelle_admin_maintenance_path(avion), 
                              data: { turbo_method: :patch, turbo_confirm: "Êtes-vous sûr de vouloir valider la visite annuelle ? La nouvelle échéance sera fixée au #{(Date.today + 1.year).strftime('%d/%m/%Y')}." }, 
                              class: "btn btn-sm btn-info text-white w-100", title: "Valider Visite Annuelle (+1 an)" do %>
                            <i class="bi bi-calendar-check"></i> Valider
                          <% end %>
                        </div>
                        </div>
                      </td>

                      <td style="height: 1px;">
                        <div class="d-flex flex-column h-100">
                          <div>
                            <div class="input-group input-group mb-1">
                              <%= f.date_field :cert_examen_navigabilite, class: "form-control fw-bold text-center" %>
                            </div>
                            
                            <div class="mb-1">
                              <%= f.file_field :cen_document, class: "form-control form-control-sm", accept: "application/pdf" %>
                            </div>

                            <% if avion.cen_document.attached? %>
                              <div class="text-end mb-1">
                                <%= link_to rails_blob_path(avion.cen_document, disposition: 'preview'), target: "_blank", class: "badge bg-secondary text-decoration-none" do %>
                                  <i class="bi bi-file-earmark-pdf me-1"></i>Voir le PDF
                                <% end %>
                              </div>
                            <% end %>

                            <% if avion.cert_examen_navigabilite %>
                              <% days_remaining_cen = (avion.cert_examen_navigabilite - Date.today).to_i %>
                              <div class="text-end mt-1">
                                <span class="<%= days_remaining_cen < 30 ? 'text-danger fw-bold' : 'text-muted' %>">
                                  <%= days_remaining_cen >= 0 ? "Dans #{days_remaining_cen} jours" : "En retard de #{days_remaining_cen.abs} jours" %>
                                </span>
                              </div>
                            <% end %>
                          </div>
                        <div class="mt-auto pt-2">
                          <%= link_to reset_cen_admin_maintenance_path(avion), 
                              data: { turbo_method: :patch, turbo_confirm: "Êtes-vous sûr de vouloir valider le CEN ? La nouvelle échéance sera fixée au #{(Date.today + 1.year).strftime('%d/%m/%Y')}." }, 
                              class: "btn btn-sm btn-info text-white w-100", title: "Valider CEN (+1 an)" do %>
                            <i class="bi bi-file-earmark-check"></i> Valider
                          <% end %>
                        </div>
                        </div>
                      </td>

                      <td class="text-center">
                        <div class="d-flex flex-column gap-2">
                          <%= f.button type: "submit", class: "btn btn btn-primary w-100", title: "Enregistrer les valeurs manuelles" do %>
                            <i class="bi bi-save me-1"></i> Enregistrer
                          <% end %>
                        </div>
                      </td>

                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <%# Pagination simple %>
          <% if @total_pages > 1 %>
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center mb-0">
                <li class="page-item <%= 'disabled' if @page <= 1 %>">
                  <%= link_to "Précédent", admin_maintenances_path(page: @page - 1, avion_id: params[:avion_id]), class: "page-link" %>
                </li>
                <li class="page-item disabled">
                  <span class="page-link">Page <%= @page %> / <%= @total_pages %></span>
                </li>
                <li class="page-item <%= 'disabled' if @page >= @total_pages %>">
                  <%= link_to "Suivant", admin_maintenances_path(page: @page + 1, avion_id: params[:avion_id]), class: "page-link" %>
                </li>
              </ul>
            </nav>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Section Historique %>
  <div class="row mt-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique des opérations</h3>
        
        <%= form_with url: admin_maintenances_path, method: :get, class: "d-flex gap-2 align-items-center" do |f| %>
          <%= f.select :avion_id, 
              options_from_collection_for_select(@avions, :id, :immatriculation, params[:avion_id]), 
              { include_blank: "Tous les avions" }, 
              class: "form-select form-select-sm", 
              onchange: "this.form.requestSubmit()" %>
          <%= link_to "Effacer", admin_maintenances_path, class: "btn btn-sm btn-outline-info" if params[:avion_id].present? %>
        <% end %>
      </div>
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Utilisateur</th>
                  <th>Avion</th>
                  <th>Action</th>
                  <th>Détails</th>
                </tr>
              </thead>
              <tbody>
                <% @logs.each do |log| %>
                  <tr>
                    <td><%= log.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                    <td><%= log.user.respond_to?(:full_name) ? log.user.full_name : log.user.email %></td>
                    <td>
                      <% avion = Avion.find_by(id: log.record_id) %>
                      <span class="badge bg-secondary"><%= avion ? avion.immatriculation : "Avion supprimé" %></span>
                    </td>
                    <td>
                      <% case log.action %>
                      <% when 'reset_100h' %>
                        <span class="badge bg-warning text-dark">Reset 100h</span>
                      <% when 'reset_moteur' %>
                        <span class="badge bg-danger">Reset Moteur</span>
                      <% when 'update_maintenance' %>
                        <span class="badge bg-info text-dark">Mise à jour manuelle</span>
                      <% when 'reset_annuelle' %>
                        <span class="badge bg-primary">Visite Annuelle</span>
                      <% when 'reset_cen' %>
                        <span class="badge bg-secondary">CEN</span>
                      <% when 'notify_grounded' %>
                        <span class="badge bg-danger">Notifications Pilotes</span>
                      <% else %>
                        <%= log.action %>
                      <% end %>
                    </td>
                    <td class="text-muted small"><%= log.details %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
