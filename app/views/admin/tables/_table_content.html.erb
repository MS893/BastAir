<h5>Contenu de la table : <%= translate_table_name(table_name) %> (<%= table_name %>)</h5>

<!-- Barre de recherche -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <!-- Barre de recherche -->
  <%= form_with(url: admin_tables_path(table_name: table_name), method: :get, class: "flex-grow-1 me-3", data: { turbo_frame: "table_content_frame", turbo_action: "advance" }) do |form| %>
    <div class="input-group">
      <%= form.hidden_field :table_name, value: table_name %>
      <% if table_name == 'activity_logs' && @available_actions.present? %>
        <%= form.select :action_type, options_for_select([['Toutes actions', '']] + @available_actions.map { |a| [a.humanize, a] }, params[:action_type]), {}, class: "form-select", style: "max-width: 180px;", onchange: "this.form.requestSubmit()" %>
      <% end %>
      <% if table_name == 'activity_logs' && @available_record_types.present? %>
        <%= form.select :record_type, options_for_select([['Tous types', '']] + @available_record_types.map { |t| [t, t] }, params[:record_type]), {}, class: "form-select", style: "max-width: 180px;", onchange: "this.form.requestSubmit()" %>
      <% end %>
      <%= form.search_field :query, value: params[:query], class: "form-control", placeholder: "Rechercher dans la table..." %>
      <%= form.hidden_field :sort_column, value: params[:sort_column] %>
      <%= form.hidden_field :sort_direction, value: params[:sort_direction] %>
      <button type="submit" class="btn btn-outline-primary">Rechercher</button>
    </div>
  <% end %>

  <!-- Bouton Nouveau, affiché conditionnellement -->
  <% if ['avions', 'tarifs'].include?(table_name) %>
    <%= link_to "Nouveau", admin_new_table_record_path(table_name: table_name), class: "btn btn-primary", data: { turbo_frame: "_top" } %>
  <% end %>
</div>

<% if records.empty? %>
  <div class="alert alert-warning">Cette table est vide.</div>
<% else %>
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <%
          visible_columns = records.first.attributes.keys - hidden_columns_for(table_name)
          # On cache les colonnes admin_id et admin_comment spécifiquement pour la table des pénalités
          if table_name == 'penalites'
            visible_columns -= ['admin_id', 'admin_comment']
          end
        %>
        <tr>
          <% visible_columns.each do |col| %>
            <% if table_name == 'penalites' && col == 'avion_immatriculation' %>
              <th><%= sanitize(sortable_header(col, table_name, params).gsub(col.humanize, 'Avion')) %></th>
            <% else %>
              <th><%= sortable_header(col, table_name, params) %></th>
            <% end %>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% records.each do |record| %>
          <tr class="<%= 'table-danger-discarded' if table_name == 'transactions' && record.try(:discarded?) %>" data-controller="clickable-row" data-clickable-row-url-value="<%= admin_show_table_record_path(table_name: table_name, id: record.id) %>" style="cursor: pointer;">
            <% visible_columns.each do |col| %>
              <td>
                <% if table_name == 'penalites' && col == 'user_id' %>
                  <% user = User.find_by(id: record.user_id) %>
                  <%= user.present? ? user.name : "Utilisateur inconnu (ID: #{record.user_id})" %>
                <% elsif table_name == 'penalites' && col == 'avion_immatriculation' %>
                  <span style="white-space: nowrap;"><%= record.avion_immatriculation %></span>
                <% elsif table_name == 'activity_logs' && col == 'user_id' %>
                  <% user = @users_by_id && @users_by_id[record.user_id] %>
                  <%= user.present? ? "#{user.prenom} #{user.nom}" : record.user_id %>
                <% elsif (table_name == 'users' && col == 'admin') || (table_name == 'reservations' && col == 'instruction') %>
                  <% if record.send(col) %>
                    <span class="badge bg-primary">Oui</span>
                  <% else %>
                    <span class="badge bg-info text-dark">Non</span>
                  <% end %>
                <% elsif table_name == 'vols' && ['solo', 'supervise', 'nav'].include?(col) %>
                  <% if [1, true].include?(record.send(col)) %>
                    <span class="badge bg-primary">Oui</span>
                  <% else %>
                    <span class="badge bg-info text-dark">Non</span>
                  <% end %>
                <% elsif table_name == 'transactions' && col == 'mouvement' %>
                  <% if record.mouvement == 'Dépense' %>
                    <span class="badge bg-danger"><%= record.mouvement %></span>
                  <% else %>
                    <span class="badge bg-success"><%= record.mouvement %></span>
                  <% end %>
                <% else %>
                  <%= display_cell_content(record, col, table_name) %>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div data-turbo-prefetch="false">
    <%= paginate records %>
  </div>

<% end %>
