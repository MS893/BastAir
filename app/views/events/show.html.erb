<%# Fichier: app/views/events/show.html.erb %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">

      <%# --- Affichage des détails de l'événement (à adapter selon votre design) --- %>
      <div class="card mb-4">
        <% if @event.photo.attached? %>
          <%= image_tag @event.photo, class: "card-img-top", style: "max-height: 400px; object-fit: cover;" %>
        <% end %>
        <div class="card-body">
          <h1 class="card-title"><%= @event.title %></h1>
          <p class="card-text"><%= @event.description %></p>
          <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>Date :</strong> <%= l(@event.start_date, format: :long) %></li>
            <li class="list-group-item"><strong>Durée :</strong> <%= @event.duration %></li>
            <li class="list-group-item"><strong>Prix :</strong> <%= @event.is_free? ? "Gratuit" : number_to_currency(@event.price) %></li>
          </ul>
        </div>
        <%# --- Section Inscription à l'événement --- %>
        <% if user_signed_in? %>
          <div class="card-footer text-center">
            <% if @event.attendances.exists?(user_id: current_user.id) %>
              <%# L'utilisateur est déjà inscrit %>
              <%= button_to "Se désinscrire de l'événement", event_attendance_path(@event, @event.attendances.find_by(user: current_user)), method: :delete, class: "btn btn-danger", data: { turbo_confirm: "Êtes-vous sûr de vouloir vous désinscrire ?" } %>
              <p class="text-muted mt-2">Vous êtes inscrit à cet événement.</p>
            <% else %>
              <%# L'utilisateur n'est pas encore inscrit %>
              <%= button_to "S'inscrire à l'événement", event_attendances_path(@event), method: :post, class: "btn btn-success" %>
            <% end %>
          </div>
        <% else %>
          <p class="card-footer text-center">Vous devez être <%= link_to 'connecté', new_user_session_path %> pour vous inscrire.</p>
        <% end %>
      </div>

      <%# --- Section des Commentaires --- %>
      <hr class="my-4">
      <h2 class="mb-3">Commentaires (<%= @event.comments.count %>)</h2>

      <%# Conteneur pour la liste des commentaires %>
      <div id="comments" class="mb-4">
        <%# Rails va automatiquement itérer sur @event.comments et utiliser le partiel _comment.html.erb %>
        <%= render @event.comments.order(created_at: :desc) %>
      </div>

      <%# --- Formulaire pour ajouter un nouveau commentaire --- %>
      <% if user_signed_in? %>
        <%# On affiche le formulaire uniquement si l'utilisateur n'a pas déjà commenté %>
        <% if @event.comments.exists?(user_id: current_user.id) %>
          <p class="text-muted fst-italic">Vous avez déjà commenté cet événement. Vous pouvez modifier votre commentaire ci-dessus.</p>
        <% else %>
          <%= render 'comments/form', event: @event, comment: @event.comments.new %>
        <% end %>
      <% else %>
        <p>Vous devez être <%= link_to 'connecté', new_user_session_path %> pour laisser un commentaire.</p>
      <% end %>

    </div>
  </div>
</div>