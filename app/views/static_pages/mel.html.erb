<% content_for :head do %>
  <style>
    .mel-table {
      table-layout: fixed;
      width: 100%;
    }
    .col-item { width: 34%; }
    .col-installed { width: 8%; }
    .col-required { width: 8%; }
    .col-conditions { width: 50%; }
    .clickable-row {
      cursor: pointer;
    }
  </style>
<% end %>

<% content_for :title, "Minimum Equipment List (MEL)" %>
<% nogo = "<span class='text-danger fw-bold'>NO-GO</span>".html_safe %>

<div class="container my-5">

  <div class="text-center">
    <h1 class="mb-4">Minimum Equipment List (MEL)</h1>
  </div>

  <hr>

  <div class="accordion mt-4" id="preambleAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPreamble">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreamble" aria-expanded="false" aria-controls="collapsePreamble">
          <strong>1. LME Préambule</strong>
        </button>
      </h2>
      <div id="collapsePreamble" class="accordion-collapse collapse" aria-labelledby="headingPreamble" data-bs-parent="#preambleAccordion">
        <div class="accordion-body">
          <h5 class="text-primary">Introduction</h5>
          <p>Cette Liste Minimale d’Equipement (LME) est applicable dans le cadre des règlements européens relatifs aux opérations aériennes non commerciales avec un avion non complexe (Annexe VII, Part NCO du règlement UE 965/2012 modifié).</p>
          <p>Elle a été établie selon le Guide Générique d’Equipements Minimum (GGEM) publié par la FFA et conformément au NCO.GEN.155 qui permet l’exploitation de l’avion dans des conditions spécifiées, avec certains instruments, équipements ou fonctions inopérants (voir § Notes et définitions) ou manquants avec un niveau de sécurité acceptable.</p>
          <p>Cette LME a été transmise à la Direction de la Sécurité de l’Aviation Civile interrégionale de rattachement.</p>

          <h5 class="text-primary mt-4">But et Limitations</h5>
          <p>Cette LME a été développée dans le cadre des opérations non commerciales réalisées par un avion ELA1 ou ELA2 non complexe sans qu’une Liste Minimale d’Equipement de Référence (LMER) n’ait été développée par le détenteur du Certificat de Type de l’avion couvert par ce document.</p>
          <p>Cette LME a été élaborée sur la base :</p>
          <ul>
            <li>du règlement UE 965/2012 modifié, et</li>
            <li>du CS-GEN-MMEL</li>
          </ul>
          <p class="fst-italic">Note : La présente LME couvre également les vols de découverte définis à l'article 6, paragraphe 4bis, du règlement européen Air-OPS et réalisés conformément aux règles d’application fixées par l’arrêté interministériel du 18 août 2016.</p>
          <p>Cette LME contient des items liés à la navigabilité ainsi qu’aux exigences opérationnelles pouvant être inopérants ou manquants avant le début du vol sous réserve du respect de certaines conditions permettant d’assurer un niveau de sécurité satisfaisant.</p>
          <p class="fst-italic">Note : Tout équipement à bord d’un avion et non traité par cette liste doit être en état de fonctionnement s’il est relatif à la sécurité ou à l’exécution du vol envisagé par le commandant de bord.</p>
          <p>Un équipement qui n’est pas embarqué pour des raisons de sécurité (par exemple un équipement de bord présent pour le confort des passagers ou utilisé uniquement au sol à des fins de maintenance) peut être inopérant ou manquant, à condition que son non fonctionnement n’affecte pas la navigabilité ou l’utilisation sûre de l’avion (Attention : un équipement peut avoir une autre fonction ou faire partie d’un autre système de l’avion).</p>
          <p class="fst-italic">Note : Un élément inopérant ne peut pas être déposé de l'appareil sur la base de cette LME.</p>

          <h5 class="text-primary mt-4">Utilisation</h5>
          <p>La LME permet d’opérer l'avion avec certains instruments, équipements ou fonctions inopérants ou manquants pour une période limitée jusqu'à ce que la réparation puisse être réalisée.</p>
          <p class="fst-italic">Note : La LME ne permet pas de dévier d’une consigne de navigabilité, ou tout autre exigence supplémentaire obligatoire.</p>
          <p>Dans tous les cas, toute panne constatée doit faire l’objet d’une inscription au carnet de route de l’avion. En effet, la réglementation requiert que toute anomalie, incident ou accident soit indiqué sur le carnet de route de l’avion, au plus tard en fin de journée, après tout vol.</p>
          <p>L’équipement est alors réparé ou alors sa remise en service est reportée sur la base de l’item LME correspondant.</p>
          <p class="fst-italic">Note : L’item LME correspondant est indiqué dans la colonne (1) de la LME. Il est spécifique à chaque équipement ou fonction ou conditions applicables.</p>
          <p>Le pilote peut remettre l’avion en vol sur la base de l’item LME applicable en prenant en compte les conditions et remarques applicables. Pour cela il fait une inscription au carnet de route en identifiant l’item LME. Le report de la réparation est limité au(x) vol(s) pour revenir à sa base uniquement.</p>
          <p>Le responsable technique est le seul habilité à définir l’intervalle de réparation (voir paragraphe « Intervalle de réparation ») dans un délai raisonnable. Pour cela il indique sur le carnet de route, l’item LME et le délai pour corriger le défaut avant que l’avion puisse être de nouveau utilisé.</p>
          <p class="fst-italic">Note : Tout instrument, équipement ou fonction inopérant dont la réparation est reportée doit être clairement physiquement identifié pour le pilote comme « inopérant ».</p>
          <p>Dans l’intervalle de réparation défini par le responsable technique, les pilotes doivent remplir le carnet de route de l’avion en indiquant dans la colonne remarques/observations « Item(s) pris en compte / Autres remarques/observations ou RAS ».</p>
          <p>L’indication « item(s) pris en compte » doit être annotée au début du vol pour indiquer que le pilote a bien pris connaissance de la panne de l’équipement ou de la fonction et qu’il a également pris connaissance des limitations, conditions et éventuelles restrictions qui s’appliquent à l’avion et que le vol est réalisable.</p>
          <p>L’ajout d’une/de panne(s) ou l’indication « RAS » au carnet de route se fait à la fin du vol.</p>

          <h5 class="text-primary mt-4">Combinaison de pannes</h5>
          <p>En cas de combinaison de pannes, il revient à l’exploitant de garantir un niveau de sécurité satisfaisant, les relations entre items devant toujours être considérées.</p>

          <h5 class="text-primary mt-4">Intervalle de réparation</h5>
          <p>Bien que la LME n’indique pas d’intervalles de réparation, sauf pour les balises de détresse (25-63), il est important que ces réparations soient entreprises le plus rapidement possible par l’exploitant.</p>
          <p>Le responsable technique a la charge, compte tenu des contraintes (approvisionnement, plan de charge, visite programmée, caractéristique du défaut, etc.), de définir l’intervalle de réparation et son suivi. Cet intervalle doit être inscrit sur le carnet de route. Il ne peut, en aucun cas, excéder 13 mois.</p>

          <h5 class="text-primary mt-4">Notes et définitions</h5>
          <p>La colonne « <strong>Numérotation Item et système</strong> » (1) liste les instruments, équipements, systèmes ou fonctions susceptibles d’être requis à bord ou installés sur l’avion.</p>
          <p>La colonne « <strong>Nombre installé</strong> » (2) indique le nombre d’items ou système installés sur l’avion concerné par cette LME.</p>
          <p>La colonne « <strong>Nombre requis</strong> » (3) indique le nombre minimum d’items en état de fonctionnement requis pour un type d’opérations, lorsque les exigences de la colonne « Conditions et Remarques » (4) sont respectées. Le symbole « - » est utilisé lorsque ce nombre dépend des conditions d’utilisation telles que décrites dans la colonne (4).</p>
          <p>La colonne « <strong>Conditions et Remarques</strong> » (4) décrit les conditions et procédures éventuelles à respecter afin que le vol puisse être entamé avec un nombre d’items correspondant à celui indiqué dans la colonne (3).</p>
          <p>Le terme « <strong>inopérant</strong> » désigne tout item ne pouvant pas remplir correctement sa fonction à bord et qui est clairement identifié comme tel pour le pilote.</p>
          <p>Un « <strong>avion ELA1</strong> » signifie European Light Aircraft (avion léger européen) avec une masse maximale au décollage (MTOM) n’excédant pas 1 200 kg et non classé comme avion à motorisation complexe.</p>
          <p>Un « <strong>avion ELA2</strong> » signifie European Light Aircraft (avion léger européen) avec une masse maximale au décollage (MTOM) n’excédant pas 2 000 kg et non classé comme avion à motorisation complexe.</p>
          <p>Un « <strong>TMG</strong> » désigne une classe spécifique de planeurs motorisés pourvus d’un moteur intégré et non rétractable et d’une hélice non rétractable.</p>
          <p><strong>Vol VFR</strong> désigne un vol effectué à bord d’un avion selon les règles de vol à vue telles que précisées par les règles SERA.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion mt-4" id="itemsAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingItems">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseItems" aria-expanded="true" aria-controls="collapseItems">
          <strong>2. Liste des équipements</strong>
        </button>
      </h2>
      <div id="collapseItems" class="accordion-collapse collapse show" aria-labelledby="headingItems" data-bs-parent="#itemsAccordion">
        <div class="accordion-body">

          <%# --- Accordéon interne pour les chapitres --- %>
          <div class="accordion" id="chaptersAccordion">

            <% cache ["mel_list", Mel.maximum(:updated_at)] do %>
            <% Mel.order(:id).group_by(&:title_1).each_with_index do |(chapter, mels), index| %>
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading<%= index %>">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                    <%= chapter %>
                  </button>
                </h2>
                <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#chaptersAccordion">
                  <div class="accordion-body p-2">
                    <% 
                      table_rows = mels.map do |mel|
                        note_content = mel.tolerance
                        if note_content.strip.downcase == 'nogo'
                          note_content = nogo
                        end
                        { name: mel.title_2, installed: mel.installed, required: mel.required, notes: note_content }
                      end
                    %>
                    <%= render_chapter_table(table_rows) %>
                  </div>
                </div>
              </div>
            <% end %>
            <% end %>

          </div>

        </div>
      </div>
    </div>
  </div>
  
  <%# Affiche le bouton de retour uniquement si l'utilisateur vient de la page de la check-list %>
  <% if request.referer && URI(request.referer).path == check_list_path %>
    <div class="text-center mt-5">
      <%= link_to check_list_path, class: "btn btn-outline-primary" do %>
        <i class="bi bi-card-checklist me-2"></i>
        Retour à la check-list
      <% end %>
    </div>
  <% end %>

</div>

<%# --- Modal pour l'avion NOGO --- %>
<div class="modal fade" id="nogoModal" tabindex="-1" aria-labelledby="nogoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-marron text-white">
        <h5 class="modal-title" id="nogoModalLabel">Procédure Avion "No-Go"</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Si un équipement est défectueux et rend l'avion "No-Go" (inapte au vol) selon la MEL, voici la procédure à suivre :</p>
        <ol>
          <li><strong>Consultez un instructeur :</strong> Ne prenez aucune décision seul. Contactez immédiatement un instructeur de l'aéroclub pour évaluer la situation.</li>
          <li><strong>Si la panne est confirmée :</strong> Avec l'aide de l'instructeur, inscrivez clairement la panne sur le carnet de route de l'avion (<span id="nogo-item-details" class="fw-bold"></span> HS)</li>
          <li><strong>Attention :</strong> après avoir rempli le carnet de route, l'avion doit obligatoirement obtenir l'APRS avant de pouvoir revoler.</li>
          <li><strong>Ne volez pas :</strong> Ne tentez en aucun cas de voler avec un avion déclaré "No-Go" avant que la maintenance nécessaire ait été effectuée et que l'avion soit officiellement déclaré apte au vol.</li>
        </ol>
        <p class="mt-3"><strong>La sécurité est toujours la priorité absolue.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  // Sélectionne toutes les lignes cliquables
  const clickableRows = document.querySelectorAll('.clickable-row');
  // Sélectionne l'élément dans la modale où afficher les détails
  const nogoItemDetails = document.getElementById('nogo-item-details');
  const modalElement = document.getElementById('nogoModal');

  if (modalElement) {
    // Utilise getOrCreateInstance pour éviter les conflits d'instances (bug du backdrop)
    const nogoModal = bootstrap.Modal.getOrCreateInstance(modalElement);

    clickableRows.forEach(row => {
      // Vérifie si l'événement est déjà attaché pour éviter les doublons
      if (row.dataset.listenerAttached) return;
      row.dataset.listenerAttached = "true";

      row.addEventListener('click', function() {
        // Récupère le nom de l'item depuis l'attribut data-item-name
        const itemName = this.dataset.itemName;
        nogoItemDetails.textContent = itemName;
        nogoModal.show();
      });
    });
  }
}, { once: true });
</script>
