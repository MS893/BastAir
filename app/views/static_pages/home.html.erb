
<% if user_signed_in? %>


  <div class="dashboard-layout d-flex">
    <!-- Tableau de bord -->
    <main class="dashboard-content"><%= render 'static_pages/dashboard' %></main>
  </div>

  <%# Script pour la modale d'annulation, uniquement si l'utilisateur est connecté %>
  <script type="text/javascript">
    <%# On charge les paramètres de pénalité depuis la BDD et on les prépare pour JS %>
    <%
      # On récupère les seuils de pénalité depuis le cache pour optimiser.
      # Le cache expirera après 1 heure, ou lorsque les paramètres seront modifiés.
      penalty_settings = Rails.cache.fetch('penalty_settings', expires_in: 1.hour) do
        settings_hash = Setting.where("var LIKE 'penalty_%'").pluck(:var, :val).to_h
        (1..3).map do |i|
          delay = settings_hash["penalty_delay_#{i}"].to_i
          amount = settings_hash["penalty_amount_#{i}"].to_i
          delay > 0 && amount > 0 ? { delay: delay, amount: amount } : nil
        end.compact.sort_by { |h| h[:delay] } # Tri par délai croissant (ex: 12, 24, 48)
      end
    %>
    const penaltySettings = <%= raw penalty_settings.to_json %>;

    document.addEventListener('turbo:load', function() {
      const cancellationModal = document.getElementById('cancellationModal');
      if (cancellationModal) {
        cancellationModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget; // Le bouton qui a déclenché la modale
          const reservationId = button.getAttribute('data-reservation-id');
          const timeBeforeFlight = parseFloat(button.getAttribute('data-time-before-flight'));
          const formContent = document.getElementById('modal-cancellation-form-content');

          // Construire le formulaire dynamiquement
          let formHTML = `<form action="/reservations/${reservationId}" method="post">
                            <input type="hidden" name="_method" value="delete">
                            <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name="csrf-token"]').content}">`;

          // On cherche la première règle de pénalité qui s'applique
          const applicablePenalty = penaltySettings.find(p => timeBeforeFlight < p.delay * 3600);
          const maxPenaltyDelay = penaltySettings.length > 0 ? Math.max(...penaltySettings.map(p => p.delay)) : 0;

          if (applicablePenalty) {
            const alertClass = applicablePenalty.delay <= 24 ? 'alert-danger' : 'alert-warning';
            formHTML +=  `<div class="alert ${alertClass}" role="alert">
                            <strong>Pénalité de ${applicablePenalty.amount}€ :</strong> Vous annulez moins de ${applicablePenalty.delay} heures avant le vol.
                            <small class="d-block mt-1">Si un administrateur estime votre raison valable, la pénalité pourra être annulée.</small>
                          </div>`;
          }

          // On ajoute le champ "raison" si l'annulation est dans le délai de la plus grande pénalité
          // (ex: si la plus grande pénalité est à 48h, on demande la raison en dessous de 48h)
          if (maxPenaltyDelay > 0 && timeBeforeFlight < maxPenaltyDelay * 3600) {
            formHTML += `<div class="mb-3">
                            <label for="cancellation_reason" class="form-label">Raison de l'annulation (obligatoire) :</label>
                            <textarea name="cancellation_reason" id="cancellation_reason" class="form-control" rows="3" required></textarea>
                          </div>`;
          }

          formHTML +=  `<div class="modal-footer border-0 p-0 pt-3">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ne pas annuler</button>
                          <button type="submit" class="btn btn-danger">Confirmer l'annulation</button>
                        </div></form>`;

          formContent.innerHTML = formHTML;
        });
      }
    });
  </script>


<% else %>


  <%# --- Page de présentation du club pour les visiteurs --- %>
  <% content_for :title, t('static_pages.home.title') %>

  <div class="container my-5">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <h1 class="text-center mb-4"><%= t('static_pages.home.main_title') %></h1>
        <h3 class="text-center mb-5"><%= t('static_pages.home.subtitle') %></h3>
      </div>
    </div>

    <!-- Carrousel d'images -->
    <div class="row">
      <div class="col-12">
        <div id="homeCarousel" class="carousel slide shadow-lg rounded overflow-hidden mb-5" data-bs-ride="carousel" data-bs-keyboard="true" data-bs-carousel-init>
          <div class="carousel-indicators">
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="5" aria-label="Slide 6"></button>
            <button type="button" data-bs-target="#homeCarousel" data-bs-slide-to="6" aria-label="Slide 7"></button>
          </div>
          <div class="carousel-inner text-white">
            <div class="carousel-item active" data-bs-interval="4000">
              <%= image_tag 'TFFB (1).jpg', class: 'd-block w-100', alt: 'nuages' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.sky_title') %></h4>
                <p><%= t('static_pages.home.carousel.sky_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB (11).jpg', class: 'd-block w-100', alt: 'piste' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.runway_title') %></h4>
                <p><%= t('static_pages.home.carousel.runway_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB (17).jpg', class: 'd-block w-100', alt: 'nuages' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.playground_title') %></h4>
                <p><%= t('static_pages.home.carousel.playground_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB (7).jpg', class: 'd-block w-100', alt: 'accueil' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.facilities_title') %></h4>
                <p><%= t('static_pages.home.carousel.facilities_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB (14).jpg', class: 'd-block w-100', alt: 'piste' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.runway_14_32_title') %></h4>
                <p><%= t('static_pages.home.carousel.runway_14_32_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB (8).jpg', class: 'd-block w-100', alt: 'nuages' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.sunset_title') %></h4>
                <p><%= t('static_pages.home.carousel.sunset_text') %></p>
              </div>
            </div>
            <div class="carousel-item" data-bs-interval="4000">
              <%= image_tag 'TFFB.jpg', class: 'd-block w-100', alt: 'piste' %>
              <div class="carousel-caption d-none d-md-block text-white">
                <h4><%= t('static_pages.home.carousel.takeoff_title') %></h4>
                <p><%= t('static_pages.home.carousel.takeoff_text') %></p>
              </div>
            </div>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Préc</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Suiv</span>
          </button>
        </div>
      </div>
    </div>


    <div class="row">
      <div class="col-lg-8 mx-auto">
        <p class="lead text-center">
          <%= t('static_pages.home.welcome_lead') %>
        </p>
        <hr class="my-5">
        
        <h2 class="mt-4"><%= t('static_pages.home.history_title') %></h2>
        <p>
          <%= t('static_pages.home.history_text') %>
        </p>
        <div class="row align-items-center">
          <div class="col-md-8">
            <ul>
              <li><%= t('static_pages.home.history_list.guadeloupe') %></li>
              <li><%= t('static_pages.home.history_list.caribbean') %></li>
            </ul>
          </div>
          <div class="col-md-4">
            <%= image_tag 'Gwada1.jpg', class: 'img-fluid rounded shadow-sm my-3', alt: 'carte' %>
          </div>
        </div>

        <h2 class="mt-5"><%= t('static_pages.home.facilities_title') %></h2>
        <p>
          <%= t('static_pages.home.facilities_text') %>
        </p>
        <div class="row align-items-center">
          <div class="col-md-8">
            <ul>
              <li><%= t('static_pages.home.facilities_list.clubhouse') %></li>
              <li><%= t('static_pages.home.facilities_list.classroom') %></li>
              <li><%= t('static_pages.home.facilities_list.hangar') %></li>
            </ul>
          </div>
          <div class="col-md-4">
            <%= image_tag 'TFFB (10).jpg', class: 'img-fluid rounded shadow-sm my-3', alt: 'Hangar' %>
          </div>
        </div>

        <h2 class="mt-5"><%= t('static_pages.home.pilot_training_title') %></h2>
        <p>
          <%= t('static_pages.home.pilot_training_text') %>
        </p>
        <ul>
          <li><%= t('static_pages.home.pilot_training_list.simulator') %></li>
          <li><%= t('static_pages.home.pilot_training_list.avionics') %></li>
          <li><%= t('static_pages.home.pilot_training_list.leisure_pro') %></li>
          <li><%= t('static_pages.home.pilot_training_list.financial_aid') %></li>
          <li><%= t('static_pages.home.pilot_training_list.bia') %></li>
          <li><%= t('static_pages.home.pilot_training_list.rsfi') %></li>
          <li><%= t('static_pages.home.pilot_training_list.trial') %></li>
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-10 mx-auto">
        <%= image_tag 'TFFB (16).jpg', class: 'img-fluid rounded shadow-sm my-3', alt: 'piste' %>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="text-center mt-5">
          <%= link_to t('static_pages.home.join_us'), contact_path, class: "btn btn-primary btn-lg" %>
        </div>
        
        <h2 class="mt-5"><%= t('static_pages.home.bapteme_section_title') %></h2>
        <div class="row align-items-center">
          <div class="col-md-4">
            <%= image_tag 'Gwada2.jpg', class: 'img-fluid rounded shadow-sm my-3', alt: 'satellite' %>
          </div>
          <div class="col-md-8">
            <p>
              <%= t('static_pages.home.bapteme_text') %>
            </p>
          </div>
        </div>
        <div class="row align-items-center mt-3">
          <div class="col-md-8">
            <p><%= t('static_pages.home.bapteme_subtext') %></p>
          </div>
          <div class="col-md-4">
            <%= image_tag 'TFFB (15).jpg', class: 'img-fluid rounded shadow-sm my-3', alt: 'souffrière' %>
          </div>
        </div>

        <div class="text-center mt-5">
          <%= link_to t('static_pages.home.bapteme_button'), baptemes_path, class: "btn btn-primary btn-lg" %>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-10 mx-auto">
        <%= image_tag 'TFFB (5).jpg', class: 'd-block w-100 rounded shadow-sm mt-5 mb-3', style: 'opacity: 0.6;', alt: 'panneau' %>
      </div>
    </div>
  </div>
  
<% end %>
