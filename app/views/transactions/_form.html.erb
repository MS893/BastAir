<div class="card shadow-sm
">
  <div class="card-header bg-primary text-white">
    <h4 class="mb-0">Transaction</h4>
  </div>
  <div class="card-body">
    <%# On utilise form_with, comme dans le formulaire de création d'adhérent %>
    <%= form_with(model: @transaction, local: true, data: { controller: "transaction-form" }) do |form| %>

      <%# Affichage des erreurs, inspiré du formulaire de création d'adhérent %>
      <% if @transaction.errors.any? %>
        <div class="alert alert-danger">
          <h5><%= pluralize(@transaction.errors.count, "erreur") %> a empêché cette transaction d'être sauvegardée :</h5>
          <ul>
            <% @transaction.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <h5 class="mb-3">Informations principales</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :date_transaction, "Date de la transaction" %>
          <%= form.date_field :date_transaction, class: "form-control" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :montant %>
          <%= form.number_field :montant, class: "form-control", step: '0.01', placeholder: "0" %>
        </div>
      </div>
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <%= form.label :description, "Description" %>
          <select class="form-select form-select-sm w-auto" onchange="if(this.value) { document.getElementById('transaction_description').value = this.value; }">
            <option value="">Descriptions prédéfinies...</option>
            <option value="Crédit compte pilote">Crédit compte pilote</option>
            <option value="Débit compte pilote">Débit compte pilote</option>
            <option value="Visite 100h">Visite 100h</option>
            <option value="Visite annuelle">Visite annuelle</option>
          </select>
        </div>
        <%= form.text_area :description, class: "form-control", placeholder: "Description de la transaction", rows: 3 %>
      </div>

      <hr class="my-4">
      <h5 class="mb-3">Catégorisation</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= form.label :mouvement, "Type" %>
          <%= form.select :mouvement, Transaction::ALLOWED_MVT.values, { prompt: 'Sélectionner...' }, class: "form-select", data: { transaction_form_target: "mouvement", action: "change->transaction-form#updateSourceOptions" } %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :source_transaction, "Origine" %>
          <%# La collection est vide, car elle sera remplie dynamiquement par Stimulus %>
          <%= form.select :source_transaction, [], { prompt: 'Sélectionner un type...' }, class: "form-select", data: { transaction_form_target: "source" } %>
        </div>
        <div class="col-md-4 mb-3"><%= form.label :payment_method, "Paiement" %> <%= form.select :payment_method, Transaction::ALLOWED_PYT.values, { prompt: 'Sélectionner...' }, class: "form-select" %></div>
      </div>
      <div class="mb-3">
        <%= form.label :user_id, "Lié à l'adhérent" %>
        <%# --- Début du composant d'autocomplétion --- %>
        <div data-controller="autocomplete" class="position-relative">          
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <%# Champ de texte visible pour la recherche %>
            <input type="text" class="form-control" data-autocomplete-target="input" data-action="input->autocomplete#search" placeholder="Recherche par nom ou prénom..." autocomplete="off">
          </div>
          
          <%# Champ caché qui contiendra l'ID de l'utilisateur et sera envoyé avec le formulaire %>
          <%= form.hidden_field :user_id, data: { autocomplete_target: "hidden" } %>

          <%# Le Turbo Frame qui recevra et affichera les résultats de la recherche %>
          <turbo-frame id="search_results" class="position-absolute w-100 d-none" data-autocomplete-target="results" src="<%= search_users_path %>" style="z-index: 1000;"></turbo-frame>
        </div>
      </div>

      <div class="form-check form-switch mb-3"><%= form.check_box :is_checked, class: "form-check-input" %> <%= form.label :is_checked, "Rapproché en banque", class: "form-check-label" %></div>

      <div class="form-actions mt-4 border-top pt-3">
        <%= form.submit "Enregistrer la transaction", class: "btn btn-success" %>
        <%= link_to 'Annuler', transactions_path, class: 'btn btn-outline-primary ms-2' %>
      </div>

    <% end %>
  </div>
</div>
