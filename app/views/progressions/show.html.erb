<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Livret de Progression</h1>
    <% if @selected_eleve %>
      <%= link_to download_livret_progression_path(eleve_id: @selected_eleve.id), class: "btn btn-outline-primary" do %>
        <i class="fas fa-file-pdf me-2"></i> Télécharger en PDF
      <% end %>
    <% end %>
  </div>

  <%# --- Sélecteur d'élève pour les instructeurs --- %>
  <% if current_user.instructeur? || current_user.admin? %>
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Sélectionner un élève</h5>
        <%= form_with(url: livret_progression_path, method: :get, local: true, class: "d-flex align-items-center") do |form| %>
          <div class="flex-grow-1 me-2">
            <%= form.select :eleve_id, options_from_collection_for_select(@eleves, :id, :full_name, params[:eleve_id]), { include_blank: 'Choisissez un élève...' }, { class: 'form-select', onchange: 'this.form.submit()' } %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# --- Affichage du livret de progression --- %>
  <% if @selected_eleve %>                                                                    
    <div class="card">
      <div class="card-header">
        <h4>
          Progression de <%= @selected_eleve.full_name %>
        </h4>
      </div>
      <div class="card-body">
        <div class="accordion" id="progressionAccordion" data-controller="progression-form">

          <%# --- Accordion: Examens Théoriques --- %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                Examens Théoriques (<%= @examens_theoriques.count %>)
              </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#progressionAccordion">
              <div class="accordion-body">
                <%= turbo_frame_tag "examens_theoriques_list", "data-turbo-preserve-scroll": "true" do %>
                  <% if @examens_theoriques.present? %>
                    <ul class="list-group">
                      <% @examens_theoriques.each do |livret| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center" data-controller="progression-form">
                          <%= form_with(model: livret, url: livret_path(livret), method: :patch, class: "d-flex align-items-center flex-grow-1") do |f| %>
                            <%= f.check_box :status, { id: "livret_status_#{livret.id}", class: 'form-check-input me-3', data: { action: 'change->progression-form#submitForm' }, checked: livret.status == 3, disabled: !current_user.instructeur? }, 3, 0 %>
                            <%= f.label :status, livret.title, class: "mb-0 flex-grow-1", for: "livret_status_#{livret.id}" %>
                            <% if livret.status == 3 %>
                              <% if current_user.instructeur? %>
                                <%= f.date_field :date, value: livret.date&.strftime('%Y-%m-%d'), class: "form-control form-control-sm ms-2", style: "width: 150px;", data: { action: 'change->progression-form#submitForm' } %>
                              <% elsif livret.date.present? %>
                                <span class="badge bg-light text-dark fw-normal ms-2">Validé le <%= l(livret.date, format: :short_year) %></span>
                              <% end %>
                            <% end %>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  <% else %>
                    <p class="text-muted">Aucun examen théorique pour le moment.</p>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <%# --- Accordion: Formations Théoriques de Proximité --- %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                Formations Théoriques de Proximité (<%= @formations_theoriques.count %>)
              </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#progressionAccordion">
              <div class="accordion-body">
                <% if @formations_theoriques.present? %>
                  <ul class="list-group">
                    <% @formations_theoriques.each do |livret| %>
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <%= livret.title %>
                        <% if livret.status == 3 && livret.date.present? %>
                          <span class="badge bg-success ms-2 fw-normal">
                            <i class="fas fa-check-circle me-1"></i> Validé le <%= l(livret.date, format: :short_year) %>
                          </span>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <p class="text-muted">Aucune formation théorique pour le moment.</p>
                <% end %>
              </div>
            </div>
          </div>

          <%# --- Accordion: Leçons en Vol --- %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                Leçons en Vol (<%= @lecons_en_vol.count %>)
              </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse show" aria-labelledby="headingThree" data-bs-parent="#progressionAccordion">
              <div class="accordion-body">
                <% if @lecons_en_vol.present? %>
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Titre de la leçon</th>
                          <th>Statut</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% @lecons_en_vol.each do |livret| %>
                          <tr>
                            <td><%= livret.date? ? l(livret.date, format: :short_year) : '' %></td>
                            <td><%= livret.flight_lesson.title %></td>
                            <td><%= livret.status %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                <% else %>
                  <p class="text-muted">Aucune leçon de vol enregistrée pour le moment.</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% elsif current_user.instructeur? %>
    <div class="alert alert-info" role="alert">
      Veuillez sélectionner un élève dans la liste ci-dessus pour afficher son livret de progression.
    </div>
  <% end %>
</div>