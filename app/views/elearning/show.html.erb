<% content_for :title, @course.title %>

<div class="container my-5" data-controller="quiz-page">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0 h2"><%= @course.title %></h1>
    <%= link_to 'Retour à la liste des cours', elearning_index_path, class: 'btn btn-secondary' %>
  </div>

  <%= simple_format(@course.description, class: 'lead') %>
  <hr>
  <%# On affiche le contenu Markdown en priorité s'il existe %>
  <% if @markdown_content %>
    <div class="markdown-content p-3 border rounded">
      <%= @markdown_content %>
    </div>
  <%# Sinon, on cherche un document PDF attaché %>
  <% elsif @course.document.attached? %>
    <div class="pdf-viewer-container" style="height: 80vh; border: 1px solid #dee2e6; border-radius: .25rem;">
      <embed src="<%= rails_blob_path(@course.document) %>" type="application/pdf" width="100%" height="100%">
    </div>
  <% else %>
    <div class="alert alert-warning text-center" role="alert">
      Aucun contenu ou document n'est disponible pour ce cours.
    </div>
  <% end %>
  <hr class="my-5">

  <%# --- Bouton pour lancer le quiz ou message de validation --- %>
  <% if @quiz_validated %>
    <div class="alert alert-success text-center" role="alert">
      <i class="fas fa-check-circle me-2"></i>
      Vous avez déjà validé et signé ce cours.
    </div>
  <% else %>
    <div class="text-center" data-quiz-page-target="launchButtonContainer">
      <button type="button" class="btn btn-info btn-lg" data-action="click->quiz-page#showQuiz">
        Lancer le Quiz de validation
      </button>
    </div>
  <% end %>

  <!-- Section Quiz (masquée tant que l'on ne clique pas sur le bouton) -->
  <div class="d-none mt-4 p-4 border rounded" data-quiz-page-target="quizSection" data-controller="quiz-reponses" data-quiz-reponses-quiz-page-outlet=".container[data-controller='quiz-page']">
    <h5 class="mb-3">Quiz pour : <%= @course.title %></h5>
    <p>Répondez à toutes les questions pour valider vos connaissances.</p>

    <%# Boucle sur les questions du cours %>
    <% @course.questions.each_with_index do |question, index| %>
      <div class="mb-4" data-quiz-reponses-target="question">
        <h6>Question <%= index + 1 %> : <%= question.qcm %></h6>
        
        <%# Affichage des 4 réponses possibles %>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q<%= question.id %>" value="1" data-action="change->quiz-reponses#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 1 %>>
          <label class="form-check-label"><%= question.answer_1 %></label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q<%= question.id %>" value="2" data-action="change->quiz-reponses#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 2 %>>
          <label class="form-check-label"><%= question.answer_2 %></label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q<%= question.id %>" value="3" data-action="change->quiz-reponses#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 3 %>>
          <label class="form-check-label"><%= question.answer_3 %></label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q<%= question.id %>" value="4" data-action="change->quiz-reponses#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 4 %>>
          <label class="form-check-label"><%= question.answer_4 %></label>
        </div>
      </div>
    <% end %>

    <div class="mt-4">
      <%= link_to signature_livret_path(@livret), class: "text-decoration-none" do %>
        <button type="button" class="btn btn-success d-none" data-quiz-reponses-target="validateButton" data-action="click->quiz-reponses#validate">Valider le Quiz</button>
      <% end %>
    </div>
  </div>

</div>
