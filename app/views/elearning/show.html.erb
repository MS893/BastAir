<% content_for :title, @course.title %>

<div class="container my-5" data-controller="quiz-page">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0 h2"><%= @course.title %></h1>
    <%= link_to 'Retour à la liste des cours', elearning_index_path, class: 'btn btn-secondary' %>
  </div>

  <%= simple_format(@course.description, class: 'lead') %>

  <hr>

  <% if @course.document.attached? %>
    <div class="pdf-viewer-container" style="height: 80vh; border: 1px solid #dee2e6; border-radius: .25rem;">
      <embed src="<%= rails_blob_path(@course.document) %>" type="application/pdf" width="100%" height="100%">
    </div>
  <% else %>
    <div class="alert alert-warning text-center" role="alert">
      Aucun document n'est disponible pour ce cours.
    </div>
  <% end %>

  <hr class="my-5">

  <div class="text-center">
    <button type="button" class="btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#quizModal">
      Lancer le Quiz de validation
    </button>
  </div>

  <!-- Modal pour le Quiz -->
  <div class="modal fade" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true" data-quiz-page-target="modal" data-controller="quiz-modal" data-quiz-modal-quiz-page-outlet=".container[data-controller='quiz-page']">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="quizModalLabel">Quiz pour : <%= @course.title %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Répondez à toutes les questions pour valider vos connaissances.</p>

          <%# Boucle sur les questions du cours %>
          <% @course.questions.each_with_index do |question, index| %>
            <div class="mb-4" data-quiz-modal-target="question">
              <h6>Question <%= index + 1 %> : <%= question.text %></h6>
              
              <%# Affichage des 4 réponses possibles %>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q<%= question.id %>" value="1" data-action="change->quiz-modal#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 1 %>>
                <label class="form-check-label"><%= question.answer_1 %></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q<%= question.id %>" value="2" data-action="change->quiz-modal#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 2 %>>
                <label class="form-check-label"><%= question.answer_2 %></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q<%= question.id %>" value="3" data-action="change->quiz-modal#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 3 %>>
                <label class="form-check-label"><%= question.answer_3 %></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q<%= question.id %>" value="4" data-action="change->quiz-modal#checkAnswers" <%== 'data-correct="true"' if question.correct_answer == 4 %>>
                <label class="form-check-label"><%= question.answer_4 %></label>
              </div>
            </div>
          <% end %>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-success d-none" data-quiz-modal-target="validateButton" data-action="click->quiz-modal#validate">Valider le Quiz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Signature -->
  <div class="d-none mt-5" data-quiz-page-target="signatureSection">
    <hr>
    <h2 class="text-center">Signature de validation du cours</h2>
    <% if @livret %>
      <%= form_with(model: @livret, url: { controller: 'livrets', action: 'update', id: @livret.id }, method: :patch, data: { controller: "signature", action: "submit->signature#save" }) do |form| %>
        <p class="text-center">Veuillez signer dans le cadre ci-dessous pour certifier que vous avez lu et compris le cours.</p>
        <%= form.hidden_field :signature_data, data: { signature_target: "output" } %>
        <div class="signature-pad-container mx-auto" style="width: 100%; max-width: 500px;">
          <canvas class="border bg-light" data-signature-target="canvas"></canvas>
        </div>
        <div class="text-center mt-3">
          <button type="button" class="btn btn-secondary" data-action="click->signature#clear">Effacer</button>
          <%= form.submit "Valider la signature", class: "btn btn-primary" %>
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-danger text-center">Le livret de l'élève n'a pas pu être chargé. La signature est désactivée.</div>
    <% end %>
  </div>

</div>
