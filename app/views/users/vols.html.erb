<% content_for :title, "Mes Vols" %>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Mon carnet de vol</h1>
    <div class="btn-group">
      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#partialTotalsModal">
        <i class="bi bi-calculator me-2"></i>Totaux partiels
      </button>
      <button type="button" class="btn btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#csvExportModal">
        <i class="bi bi-filetype-csv me-2"></i>Exporter au format CSV
      </button>
      <%= link_to "Enregistrer un nouveau vol", new_vol_path, class: "btn btn-primary" %>
    </div>
  </div>

  <%# --- Fenêtre modale pour les totaux partiels --- %>
  <div class="modal fade" id="partialTotalsModal" tabindex="-1" aria-labelledby="partialTotalsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="partialTotalsModalLabel">Calculer les totaux sur une période</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= form_with(url: vols_user_path(@user), method: :get) do |form| %>
          <div class="modal-body">
              <div class="mb-3">
                <%= form.label :start_date, "Date de début", class: "form-label" %>
                <%= form.date_field :start_date, class: "form-control", required: true %>
              </div>
              <div class="mb-3">
                <%= form.label :end_date, "Date de fin", class: "form-label" %>
                <%= form.date_field :end_date, value: Date.today, class: "form-control", required: true %>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Fermer</button>
            <%= form.submit "Calculer", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# --- Fenêtre modale pour l'export CSV --- %>
  <div class="modal fade" id="csvExportModal" tabindex="-1" aria-labelledby="csvExportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="csvExportModalLabel">Exporter les vols au format CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%# Le format: :csv est crucial pour indiquer au contrôleur de générer un CSV %>
        <%= form_with(url: vols_user_path(@user, format: :csv), method: :get) do |form| %>
          <div class="modal-body">
              <div class="mb-3">
                <%= form.label :start_date, "Date de début", class: "form-label" %>
                <%= form.date_field :start_date, class: "form-control", required: true %>
              </div>
              <div class="mb-3">
                <%= form.label :end_date, "Date de fin", class: "form-label" %>
                <%= form.date_field :end_date, value: Date.today, class: "form-control", required: true %>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Fermer</button>
            <%= form.submit "Télécharger", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# --- Affichage des totaux partiels --- %>
  <% if @partial_totals %>
    <div class="card mb-4 border-primary">
      <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
        <span>Totaux pour la période du <%= l @start_date, format: :short %> au <%= l @end_date, format: :short %></span>
        <%= link_to "", vols_user_path(@user), class: "btn-close btn-close-white", "aria-label": "Fermer" %>
      </div>
      <div class="card-body">
        <table class="table table-sm table-borderless mb-0">
          <tbody>
            <tr>
              <td><strong>Temps de vol total :</strong></td>
              <td class="text-end pe-4"><%= '%.2f' % @partial_total_duree_vol %> h</td>
              <td><strong>Atterrissages jour :</strong></td>
              <td class="text-end"><%= @partial_total_atterrissages_jour %></td>
            </tr>
            <tr>
              <td><strong>Heures CdB :</strong></td>
              <td class="text-end pe-4"><%= '%.2f' % @partial_total_heures_cdb %> h</td>
              <td><strong>Atterrissages nuit :</strong></td>
              <td class="text-end"><%= @partial_total_atterrissages_nuit %></td>
            </tr>
            <tr>
              <td><strong>Heures Double :</strong></td>
              <td class="text-end pe-4"><%= '%.2f' % @partial_total_heures_double %> h</td>
              <td><strong>Heures Instruction :</strong></td>
              <td class="text-end"><%= '%.2f' % @partial_total_heures_instruction %> h</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <% if @vols.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th rowspan="2" class="align-middle">Date</th>
            <th colspan="2">Aérodrome</th>
            <th rowspan="2" class="align-middle">Aéronef</th>
            <th rowspan="2" class="align-middle">Temps de vol</th>
            <th rowspan="2" class="align-middle">Nom du CdB</th>
            <th colspan="3">Fonction</th>
            <th colspan="2">Condition opérationnelle</th>
            <th colspan="2">Atterrissages</th>
            <th rowspan="2" class="align-middle">Remarques</th>
          </tr>
          <tr>
            <th>Départ</th>
            <th>Arrivée</th>
            <th>CdB</th>
            <th>Double</th>
            <th>Instruction</th>
            <th>Nuit</th>
            <th>IFR</th>
            <th>Jour</th>
            <th>Nuit</th>
          </tr>
        </thead>
        <tbody>
          <% @vols.each do |vol| %>
            <tr>
              <td><%= l vol.debut_vol.to_date, format: :short_year if vol.debut_vol %></td>
              <td>
                <%= vol.depart %><br>
                <small class="text-muted"><%= l vol.debut_vol, format: :short_time if vol.debut_vol %></small>
              </td>
              <td>
                <%= vol.arrivee %><br>
                <small class="text-muted"><%= l vol.fin_vol, format: :short_time if vol.fin_vol %></small>
              </td>
              <td>
                <%= vol.avion.immatriculation %>
                <small class="text-muted"><%= vol.avion.modele %></small><br>
              </td>
              <td><%= '%.2f' % vol.duree_vol %></td>
              <td>
                <% if !vol.solo? && vol.instructeur.present? %>
                  <%= vol.instructeur.name %>
                <% else %>
                  <%= vol.user.name %>
                <% end %>
              </td>
              <%# Colonne CdB : vol solo OU vol d'instruction pour l'instructeur %>
              <td><%= '%.2f' % vol.duree_vol if vol.instructeur_id.nil? || vol.type_vol == 'Instruction' %></td>
              <%# Colonne Double : vol avec instructeur, mais qui n'est pas le vol miroir de l'instructeur %>
              <td><%= '%.2f' % vol.duree_vol if vol.instructeur_id.present? && vol.type_vol != 'Instruction' %></td>
              <%# Colonne Instruction : vol en double commande pour un instructeur %>
              <td><%= '%.2f' % vol.duree_vol if @user.instructeur? && vol.type_vol == 'Instruction' %></td>
              <%# Colonne Nuit pour les conditions opérationnelles %>
              <td><%= '%.2f' % vol.duree_vol if vol.nature == 'VFR de nuit' %></td>
              <%# Colonne IFR pour les conditions opérationnelles %>
              <td><%= '%.2f' % vol.duree_vol if vol.nature == 'IFR' %></td>
              <td><%= vol.nb_atterro if vol.nature == 'VFR de jour' %></td>
              <td><%= vol.nb_atterro if vol.nature == 'VFR de nuit' %></td>
              <%# Affiche le type de vol dans les remarques, sauf si c'est "Standard" %>
              <td><%= vol.type_vol unless vol.type_vol == 'Standard' %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot class="table-group-divider">
          <tr class="fw-bold">
            <td colspan="4" class="text-end">Totaux</td>
            <td><%= '%.2f' % @total_duree_vol %></td>
            <td><%# Colonne Nom du CdB vide %></td>
            <td><%= '%.2f' % @total_heures_cdb %></td>
            <td><%= '%.2f' % @total_heures_double %></td>
            <td><%= '%.2f' % @total_heures_instruction %></td>
            <td><%= '%.2f' % @total_heures_nuit %></td>
            <td><%= '%.2f' % @total_heures_ifr %></td>
            <td><%= @total_atterrissages_jour %></td>
            <td><%= @total_atterrissages_nuit %></td>
            <td><%# Colonne Remarques vide %></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @vols %>
    </div>
  <% else %>
    <p class="text-center text-muted">Vous n'avez encore enregistré aucun vol.</p>
  <% end %>
</div>
