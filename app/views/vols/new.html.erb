<% content_for :title, "Saisie d'un nouveau vol" %>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <h1 class="text-center mb-4">Retour de vol</h1>
      <%= render 'form', vol: @vol %>
    </div>
  </div>
</div>

<%# --- DATALISTS POUR LES AÉRODROMES --- %>
<%# Ces listes fournissent des suggestions pour les champs de départ et d'arrivée. %>
<%# L'utilisateur peut toujours entrer une valeur qui n'est pas dans la liste. %>
<datalist id="aerodromes-list">
  <option value="TFFB">Basse Terre - Baillif</option>  <%# Le premier de la liste est la base de l'aéroclub c'est le terrain par défaut %>
  <option value="TFFS">Les Saintes</option>
  <option value="TFFM">Marie Galante</option>
  <option value="TFFA">La désirade</option>
  <option value="TFFC">Saint François</option>
  <option value="TFFR">Pointe à Pitre - Maryse Condé</option>
  <option value="TFFF">Martinique - Aimé Césaire</option>
  <option value="TFFJ">Saint Bathélémy</option>
  <option value="TFFG">Saint Martin</option>
  <option value="TDCF">Dominique - Canefield</option>
  <option value="TDPD">Dominique - Douglas Charles</option>
  <option value="TAPA">Antigua</option>
  <option value="TBPB">La Barbade</option>
</datalist>

<!-- MODALES ET TOASTS -->

<!-- Fenêtre Modale de Confirmation -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">
          <i class="bi bi-question-circle me-2"></i>Confirmation de l'enregistrement
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Êtes-vous sûr de vouloir enregistrer ce vol ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <%# Ce bouton va réellement soumettre le formulaire %>
        <button type="button" id="submit-form-btn" class="btn btn-success">Confirmer l'enregistrement</button>
      </div>
    </div>
  </div>
</div>

<!-- Fenêtre Modale de Sélection du Compte BIA -->
<div class="modal fade" id="biaSelectionModal" tabindex="-1" aria-labelledby="biaSelectionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="biaSelectionModalLabel">
          <i class="bi bi-bank me-2"></i>Sélection du compte BIA à débiter
        </h5>
      </div>
      <div class="modal-body">
        <p>Veuillez sélectionner le collège ou lycée pour lequel ce vol BIA a été réalisé.</p>
        <%# La liste des utilisateurs BIA est fournie par le contrôleur via @bia_users %>
        <%= select_tag :bia_user_select, options_from_collection_for_select(@bia_users, :id, :nom), prompt: "Sélectionnez un établissement...", class: "form-select" %>
        <div id="bia-selection-error" class="text-danger small mt-2" style="display: none;">Veuillez sélectionner un établissement.</div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancel-bia-selection" class="btn btn-secondary">Annuler</button>
        <button type="button" id="confirm-bia-selection" class="btn btn-primary">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<!-- Fenêtre Modale de Signalement d'Anomalie -->
<div class="modal fade" id="signalementModal" tabindex="-1" aria-labelledby="signalementModalLabel" aria-hidden="true" data-bs-focus="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="signalementModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
          Signaler une anomalie sur l'avion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%# On prépare un formulaire simple. L'action sera définie par JavaScript. %>
        <%= form_with(url: "#", method: :post, id: 'signalement-form') do |form| %>
          <div class="mb-3">
            <%= form.label :description, "Veuillez décrire l'anomalie constatée (pièce manquante ou cassée) avec le plus de détails possible :", class: "form-label" %>
            <%= form.text_area :description, class: "form-control", rows: 6, name: "signalement[description]", id: "signalement_description" %>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <%= link_to "MEL", mel_path, class: "btn btn-warning", target: "_blank" %>
            <%= form.submit "Envoyer le signalement", class: "btn btn-danger" %>
          </div>
          <%# Zone où sera injectée la liste des signalements existants %>
          <div id="existing-signalements-list" class="mt-5">
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Toast pour les notifications non-bloquantes -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i id="toast-icon" class="bi me-2"></i>
      <strong class="me-auto" id="toast-title">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-body-content">
      <!-- Le message sera injecté ici -->
    </div>
  </div>
</div>

<!-- Zone pour afficher les messages d'erreur du formulaire -->
<div id="form-error-container" class="container"></div>


<%# --- SCRIPTS --- %>
<script>

  document.addEventListener('turbo:load', function() {
    // --- INITIALISATION DES VARIABLES ---
    const volForm = document.getElementById('vol-form');
    if (!volForm) return; // S'arrête si le formulaire n'est pas sur la page
    const errorContainer = document.getElementById('form-error-container');

    const avionSelect = document.getElementById('vol_avion_id');
    // champs pour la date et l'heure de début
    const debutVolDateInput = document.getElementById('vol_debut_vol_date');
    const debutVolHourInput = document.getElementById('vol_debut_vol_hour');
    const debutVolMinuteInput = document.getElementById('vol_debut_vol_minute');
    // champs pour la date et l'heure de fin
    const finVolDateInput = document.getElementById('vol_fin_vol_date');
    const finVolHourInput = document.getElementById('vol_fin_vol_hour');
    const finVolMinuteInput = document.getElementById('vol_fin_vol_minute');
    const compteurDepartInput = document.getElementById('vol_compteur_depart');
    const compteurArriveeInput = document.getElementById('vol_compteur_arrivee');
    const dureeVolCentiemesInput = document.getElementById('vol_duree_vol');
    const dureeVolMnInput = document.getElementById('vol_duree_vol_mn');
    const soloCheckbox = document.getElementById('vol_solo');
    const costDisplay = document.getElementById('flight-cost-display');
    const submissionButton = document.getElementById('confirm-submission-btn');
    const signalementButton = document.getElementById('report-signalement-btn');
    const typeVolSelect = document.getElementById('vol_type_vol');
    const formFieldset = document.getElementById('vol-form-fieldset');

    const departInput = document.getElementById('vol_depart');
    const arriveeInput = document.getElementById('vol_arrivee');
    const requiredFields = [
      avionSelect,
      document.getElementById('vol_type_vol'),
      departInput,
      document.getElementById('vol_arrivee'),
      document.getElementById('vol_debut_vol_date'),
      compteurDepartInput,
      compteurArriveeInput,
      document.getElementById('vol_fuel_avant_vol'),
      document.getElementById('vol_fuel_apres_vol'),
      document.getElementById('vol_huile')
    ];

    // --- GESTION DE LA MODALE BIA ---
    const biaModalEl = document.getElementById('biaSelectionModal');
    const biaModal = bootstrap.Modal.getOrCreateInstance(biaModalEl);
    const biaSelect = document.getElementById('bia_user_select');
    const biaHiddenInput = document.getElementById('vol_bia_user_id');
    const confirmBiaBtn = document.getElementById('confirm-bia-selection');
    const cancelBiaBtn = document.getElementById('cancel-bia-selection');
    const biaErrorDiv = document.getElementById('bia-selection-error');
    const biaSchoolDisplay = document.getElementById('bia-school-display');

    // --- GESTION DES NOTIFICATIONS (TOAST) ---
    const toastEl = document.getElementById('notificationToast');
    // On initialise le toast avec une durée d'affichage de 3 secondes (au lieu des 5s par défaut).
    // La valeur est en millisecondes.
    const toastInstance = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 6500 });
    const toastBody = document.getElementById('toast-body-content');
    const toastTitle = document.getElementById('toast-title');
    const toastIcon = document.getElementById('toast-icon');

    function showToast(message, type = 'info', showHeader = true) {
      toastBody.textContent = message;
      const toastHeader = toastEl.querySelector('.toast-header');
      
      // Réinitialiser les classes
      toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white', 'text-dark');
      toastIcon.className = 'bi me-2';

      if (showHeader) {
        toastHeader.style.display = 'flex'; // Affiche l'en-tête
        if (type === 'success') {
          toastEl.classList.add('bg-success', 'text-white');
          toastIcon.classList.add('bi-check-circle-fill');
          toastTitle.textContent = 'Succès';
        } else if (type === 'warning') {
          toastEl.classList.add('bg-warning', 'text-dark');
          toastIcon.classList.add('bi-exclamation-triangle-fill');
          toastTitle.textContent = 'Information';
        } else if (type === 'danger') {
          toastEl.classList.add('bg-danger', 'text-white');
          toastIcon.classList.add('bi-exclamation-triangle-fill');
          toastTitle.textContent = 'Erreur';
        }
      } else {
        toastHeader.style.display = 'none'; // Masque l'en-tête
        // Applique la couleur de fond directement sur le toast
        if (type === 'success') toastEl.classList.add('bg-success', 'text-white');
        if (type === 'warning') toastEl.classList.add('bg-warning', 'text-dark');
        if (type === 'danger') toastEl.classList.add('bg-danger', 'text-white');
      }
      toastInstance.show();
    }

    // affiche une alerte flash
    function showFlashAlert(message) {
      // vide les erreurs précédentes
      errorContainer.innerHTML = '';
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger d-flex align-items-center justify-content-center';
      alertDiv.setAttribute('role', 'alert');
      alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i><div>${message}</div>`;
      errorContainer.appendChild(alertDiv);
    }

    // --- FONCTIONS DE CALCUL ET VALIDATION ---

    function calculateDurationsAndEndTime() {
      const departValue = parseFloat(compteurDepartInput.value);
      const arriveeValue = parseFloat(compteurArriveeInput.value);
      const debutDateValue = debutVolDateInput.value;
      const debutHourValue = debutVolHourInput.value;
      const debutMinuteValue = debutVolMinuteInput.value;
      let dureeCentiemes = 0;

      if (!isNaN(departValue) && !isNaN(arriveeValue) && arriveeValue > departValue) {
        dureeCentiemes = arriveeValue - departValue;
        dureeVolCentiemesInput.value = dureeCentiemes.toFixed(2);
        const dureeMinutes = Math.round(dureeCentiemes * 60);
        dureeVolMnInput.value = dureeMinutes;

        if (debutDateValue && debutHourValue && debutMinuteValue) {
          // On reconstruit la date de début complète
          const debutDate = new Date(`${debutDateValue}T${debutHourValue.padStart(2, '0')}:${debutMinuteValue.padStart(2, '0')}:00`);
          
          // On ajoute la durée du vol pour calculer la date de fin
          debutDate.setMinutes(debutDate.getMinutes() + dureeMinutes);

          // On met à jour les champs de fin de vol
          const year = debutDate.getFullYear();
          const month = (debutDate.getMonth() + 1).toString().padStart(2, '0');
          const day = debutDate.getDate().toString().padStart(2, '0');
          const hours = debutDate.getHours().toString().padStart(2, '0');
          const minutes = debutDate.getMinutes().toString().padStart(2, '0');
          
          finVolDateInput.value = `${year}-${month}-${day}`;
          finVolHourInput.value = hours;
          finVolMinuteInput.value = minutes;
        }
      } else {
        dureeVolCentiemesInput.value = '';
        finVolDateInput.value = '';
        finVolHourInput.value = '';
        finVolMinuteInput.value = '';
      }
      calculateFlightCost(dureeCentiemes);
    }

    function calculateFlightCost(dureeCentiemes) {
      if (!costDisplay) return;
      const tarifAvion = parseFloat(volForm.dataset.tarifAvion1);
      const tarifInstructeur = parseFloat(volForm.dataset.tarifInstructeur);
      const isEleve = volForm.dataset.userIsEleve === 'true';
      const isSolo = soloCheckbox ? soloCheckbox.checked : false;

      let totalCost = dureeCentiemes * tarifAvion;
      if (isEleve && !isSolo) {
        totalCost += dureeCentiemes * tarifInstructeur;
      }
      costDisplay.textContent = `Coût estimé : ${totalCost.toFixed(2)} €`;
    }

    function validateCounters() {
      const departValue = parseFloat(compteurDepartInput.value);
      const arriveeValue = parseFloat(compteurArriveeInput.value);
      if (!isNaN(departValue) && !isNaN(arriveeValue)) {
        if (arriveeValue <= departValue) {
          compteurArriveeInput.setCustomValidity("Le compteur d'arrivée doit être supérieur à celui de départ.");
        } else {
          compteurArriveeInput.setCustomValidity('');
        }
      } else {
        compteurArriveeInput.setCustomValidity('');
      }
    }

    function updateLastCounter() {
      const avionId = avionSelect.value;
      if (avionId) {
        fetch(`/avions/${avionId}/last_compteur`)
          .then(response => response.json())
          .then(data => {
            compteurDepartInput.value = data.compteur_depart;
            calculateDurationsAndEndTime();
            checkFormValidity();
          });
      }
    }

    function checkFormValidity() {
      const isFormValid = requiredFields.every(field => field && field.value.trim() !== '');
      submissionButton.disabled = !isFormValid;
    }

    // --- GESTION DE LA MODALE DE CONFIRMATION ---
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const modalSubmitButton = document.getElementById('submit-form-btn');

    submissionButton.addEventListener('click', function(event) {
      event.preventDefault();

      // On nettoie les anciens messages d'erreur
      errorContainer.innerHTML = '';

      // Validation de la longueur des codes OACI avant de montrer la modale
      if (departInput.value.length !== 4) {
        showFlashAlert("Le code OACI de départ doit comporter exactement 4 caractères.");
        return; // Bloque l'ouverture de la modale
      }
      if (arriveeInput.value.length !== 4) {
        showFlashAlert("Le code OACI d'arrivée doit comporter exactement 4 caractères.");
        return; // Bloque l'ouverture de la modale
      }

      // Validation de l'aérodrome de la taxe
      const taxeStatus = taxeSelect.value;
      const taxeAerodromeValue = taxeAerodromeInput.value.trim();
      if ((taxeStatus === "Taxe payée" || taxeStatus === "Taxe non payée") && taxeAerodromeValue === '') {
        showFlashAlert("Veuillez renseigner l'aérodrome où la taxe a été appliquée.");
        taxeAerodromeInput.focus(); // Met le focus sur le champ manquant
        return; // Bloque l'ouverture de la modale
      }
      
      modal.show();
    });

    modalSubmitButton.addEventListener('click', function() {
      volForm.submit();
    });

    // --- GESTION DE LA SÉLECTION BIA ---
    typeVolSelect.addEventListener('change', function() {
      if (this.value === 'Vol BIA') {
        // S'il n'y a qu'un seul compte BIA dans la liste, on le sélectionne automatiquement sans ouvrir la modale
        if (biaSelect && biaSelect.options.length === 2) {
          biaSelect.selectedIndex = 1; // On sélectionne le premier vrai compte (l'index 0 est le prompt)
          const selectedOption = biaSelect.options[1];

          // On met à jour le champ caché et l'affichage
          if (biaHiddenInput) biaHiddenInput.value = selectedOption.value;
          if (biaSchoolDisplay) {
            biaSchoolDisplay.textContent = selectedOption.text;
            biaSchoolDisplay.style.display = 'block';
          }
        } else {
          // S'il y a plusieurs choix ou aucun, on ouvre la modale normalement.
          biaModal.show();
        }
      } else {
        // Si on change pour un autre type de vol, on s'assure que l'ID BIA est vidé
        if (biaHiddenInput) biaHiddenInput.value = '';
        // Et on cache le nom du collège qui aurait pu être affiché
        if (biaSchoolDisplay) {
          biaSchoolDisplay.textContent = '';
          biaSchoolDisplay.style.display = 'none';
        }
      }
    });

    confirmBiaBtn.addEventListener('click', function() {
      if (biaSelect.value) {
        // On vérifie que le champ caché existe avant de lui assigner une valeur
        if (biaHiddenInput) biaHiddenInput.value = biaSelect.value;
        biaErrorDiv.style.display = 'none';

        // Affiche le nom du collège sélectionné sous le champ "Type de vol"
        const selectedOptionText = biaSelect.options[biaSelect.selectedIndex].text;
        if (biaSchoolDisplay) {
          biaSchoolDisplay.textContent = selectedOptionText;
          biaSchoolDisplay.style.display = 'block';
        }
        biaModal.hide();
      } else {
        biaErrorDiv.style.display = 'block';
      }
    });

    cancelBiaBtn.addEventListener('click', function() {
      // Si l'utilisateur annule, on réinitialise le type de vol et on cache la modale
      if (typeVolSelect) typeVolSelect.value = ''; // ou une valeur par défaut
      if (biaHiddenInput) biaHiddenInput.value = '';
      // On s'assure aussi de cacher le nom du collège
      if (biaSchoolDisplay) {
        biaSchoolDisplay.textContent = '';
        biaSchoolDisplay.style.display = 'none';
      }
      biaModal.hide();
    });

    // --- ATTACHEMENT DES ECOUTEURS D'EVENEMENTS ---

    // Associe les datalists aux champs de saisie
    if (departInput) {
      departInput.setAttribute('list', 'aerodromes-list');
      arriveeInput.setAttribute('list', 'aerodromes-list');
    }

    // Calculs principaux
    [debutVolDateInput, debutVolHourInput, debutVolMinuteInput, compteurDepartInput, compteurArriveeInput].forEach(input => {
      input.addEventListener('input', calculateDurationsAndEndTime);
    });

    // Validation des compteurs
    [compteurDepartInput, compteurArriveeInput].forEach(input => {
      input.addEventListener('input', validateCounters);
    });

    // Mise à jour du coût si la case solo change
    if (soloCheckbox) {
      soloCheckbox.addEventListener('change', () => calculateDurationsAndEndTime());
    }

    // Mise à jour du compteur de départ et du lien d'anomalie au changement d'avion
    avionSelect.addEventListener('change', () => {
      updateLastCounter();
    });

    // Validation du formulaire à chaque modification de champ requis
    requiredFields.forEach(field => {
      const eventName = field.tagName === 'SELECT' ? 'change' : 'input';
      field.addEventListener(eventName, checkFormValidity);
    });

    function selectFirstAvion() {
      // Si aucun avion n'est sélectionné (l'index est 0, correspondant au prompt "Sélectionnez un avion")
      // et qu'il y a au moins un avion dans la liste.
      if (avionSelect.options.length > 0) {
        avionSelect.selectedIndex = 0; // On sélectionne le premier avion
        // On déclenche manuellement les fonctions qui dépendent de la sélection de l'avion.
        updateLastCounter();
      }
    }

    function setDefaultAerodromes() {
      const aerodromesList = document.getElementById('aerodromes-list');
      // On s'assure que la liste et qu'elle a au moins une option
      if (aerodromesList && aerodromesList.options.length > 0) {
        // On prend la valeur de la toute première option de la liste
        const defaultAerodrome = aerodromesList.options[0].value;
        
        departInput.value = defaultAerodrome;
        arriveeInput.value = defaultAerodrome;

        // On déclenche l'événement 'input' pour que le nom complet s'affiche
        departInput.dispatchEvent(new Event('input'));
        arriveeInput.dispatchEvent(new Event('input'));
      }
    }
    // --- GESTION DE L'AFFICHAGE DU NOM DES AÉRODROMES ---
    const aerodromesDatalist = document.getElementById('aerodromes-list');
    const aerodromeMap = new Map();
    // On peuple la map avec les codes OACI et les noms complets
    Array.from(aerodromesDatalist.options).forEach(option => {
      aerodromeMap.set(option.value, option.textContent);
    });

    // Crée les éléments pour afficher les noms en clair
    const departNameDisplay = document.createElement('div');
    departNameDisplay.className = 'form-text text-muted small mt-1';
    departNameDisplay.innerHTML = '&nbsp;'; // Réserve la hauteur pour éviter le décalage
    if (departInput.parentElement) {
      departInput.parentElement.appendChild(departNameDisplay);
    }

    const arriveeNameDisplay = document.createElement('div');
    arriveeNameDisplay.className = 'form-text text-muted small mt-1';
    arriveeNameDisplay.innerHTML = '&nbsp;'; // Réserve la hauteur pour éviter le décalage
    if (arriveeInput.parentElement) {
      arriveeInput.parentElement.appendChild(arriveeNameDisplay);
    }

    function updateAerodromeName(inputElement, displayElement) {
      // Limite à 4 caractères et convertit en majuscules
      let value = inputElement.value.toUpperCase();
      inputElement.value = value.slice(0, 4);
      const code = inputElement.value;
      const fullName = aerodromeMap.get(code);
      // On utilise innerHTML pour pouvoir insérer un espace insécable
      displayElement.innerHTML = fullName ? fullName : '&nbsp;';
    }

    function clearErrorIfFieldsAreValid() {
      // Si les deux champs ont 4 caractères, on efface le message d'erreur.
      if (departInput.value.length === 4 && arriveeInput.value.length === 4) {
        errorContainer.innerHTML = '';
      }
    }

    departInput.addEventListener('input', () => { updateAerodromeName(departInput, departNameDisplay); clearErrorIfFieldsAreValid(); });
    arriveeInput.addEventListener('input', () => { updateAerodromeName(arriveeInput, arriveeNameDisplay); clearErrorIfFieldsAreValid(); });

    // --- GESTION DES NOTIFICATIONS POUR LA TAXE D'ATTERRISSAGE ---
    const taxeSelect = document.getElementById('vol_taxe_atterrissage');
    const taxeAerodromeContainer = document.getElementById('taxe-aerodrome-container');
    const taxeAerodromeInput = document.getElementById('taxe_aerodrome_input');
    if (taxeAerodromeInput) taxeAerodromeInput.setAttribute('list', 'aerodromes-list');

    if (taxeSelect) {
      taxeSelect.addEventListener('change', function() {
        const selectedValue = this.value;

        if (selectedValue === "Taxe payée") {
          taxeAerodromeContainer.style.display = 'block';
          showToast("N'oubliez pas de fournir une copie de la facture de la taxe au club.", 'success', false);
        } else if (selectedValue === "Taxe non payée") {
          taxeAerodromeContainer.style.display = 'block';
          showToast("Le club débitera votre compte à réception de la facture, prévoyez de le créditer suffisamment.", 'warning', false);
        } else {
          taxeAerodromeContainer.style.display = 'none';
          taxeAerodromeInput.value = ''; // On vide le champ s'il est masqué
        }
        // Aucune action si "Pas de taxe" est sélectionné
      });
    }


    // --- APPELS INITIAUX AU CHARGEMENT DE LA PAGE ---
    if (taxeSelect) taxeSelect.value = "Pas de taxe"; // On s'assure que la valeur par défaut est bien sélectionnée
    selectFirstAvion();
    setDefaultAerodromes();
    checkFormValidity();

    // --- GESTION DE LA MODALE DE SIGNALEMENT ---
    // On désactive la gestion automatique du focus par Bootstrap (focus: false)
    const signalementModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('signalementModal'));
    const signalementForm = document.getElementById('signalement-form');
    let lastFocusedElement = null; // Variable pour mémoriser l'élément qui a ouvert la modale
    const existingSignalementsList = document.getElementById('existing-signalements-list');

    function fetchAndDisplaySignalements(avionId) {
      // Vide la liste précédente
      existingSignalementsList.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';

      // On ajoute un paramètre `source=modal` pour que le contrôleur puisse différencier cette requête.
      fetch(`/avions/${avionId}/signalements_list?source=modal`, {
        headers: { 'Accept': 'text/html' }
      })
      .then(response => response.text())
      .then(html => {
        existingSignalementsList.innerHTML = html;
      });
    }

    signalementButton.addEventListener('click', function() {
      const avionId = avionSelect.value;
      if (avionId) {
        // Met à jour l'URL de soumission du formulaire de la modale
        signalementForm.action = `/avions/${avionId}/signalements`;
        fetchAndDisplaySignalements(avionId); // Récupère et affiche les signalements
        lastFocusedElement = document.activeElement; // Mémorise le bouton cliqué
        signalementModal.show();
      }
    });

    // Intercepte la soumission du formulaire de signalement pour le faire en AJAX
    signalementForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const descriptionField = document.getElementById('signalement_description');

      // Validation manuelle du champ description
      if (descriptionField.value.trim() === '') {
        showToast("Veuillez décrire l'anomalie avant d'envoyer le signalement.", 'danger');
        descriptionField.focus();
        return; // Arrête la soumission si le champ est vide
      }

      const formData = new FormData(this);

      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      }).then(response => {
        if (response.ok) {
          signalementModal.hide();
          descriptionField.value = ''; // Vide le champ pour la prochaine ouverture
          showToast("Signalement envoyé avec succès. Merci !", 'success');
        }
      });
    });

    // Ré-évalue la validité du formulaire principal lorsque la modale de signalement se ferme.
    // C'est nécessaire car l'ouverture de la modale peut désactiver le formulaire principal.
    const signalementModalElement = document.getElementById('signalementModal');
    signalementModalElement.addEventListener('hidden.bs.modal', function () {
      existingSignalementsList.innerHTML = ''; // Vide la liste des signalements à la fermeture
      // Utilise setTimeout pour s'assurer que ce code s'exécute après que Bootstrap a fini son nettoyage.
      setTimeout(() => {
        // Force la réactivation du formulaire principal.
        if (formFieldset) formFieldset.disabled = false;
        // Restaure manuellement le focus sur l'élément qui a ouvert la modale.
        if (lastFocusedElement) lastFocusedElement.focus();
        // Met à jour l'état du bouton de soumission.
        checkFormValidity();
      }, 0);
    });

    // Nettoyage avant que Turbo ne mette la page en cache
    document.addEventListener('turbo:before-cache', function() {
      signalementModal.dispose();
      // On pourrait aussi disposer la modale de confirmation ici si elle posait problème
    }, { once: true });
  });
  
</script>